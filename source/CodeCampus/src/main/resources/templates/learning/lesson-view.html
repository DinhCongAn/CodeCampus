<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf}"/>

    <title>B√†i h·ªçc: [[${currentLesson.name}]] | CodeCampus</title>

    <!-- ================= FONTS & ICONS ================= -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- ================= ANIMATION & ALPINE ================= -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="//unpkg.com/alpinejs" defer></script>

    <!-- ================= TAILWIND & CONFIG ================= -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="icon" th:href="@{/images/logo.png}" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
                        'glow': '0 0 40px -10px rgba(99, 102, 241, 0.5)',
                        'card-hover': '0 20px 40px -5px rgba(99, 102, 241, 0.15), 0 10px 20px -5px rgba(0, 0, 0, 0.04)',
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                color: '#334155',
                                maxWidth: '100%',
                                h1: { color: '#1e293b', fontWeight: '800' },
                                h2: { color: '#1e293b', fontWeight: '700' },
                                strong: { color: '#4f46e5', fontWeight: '700' },
                                a: { color: '#4f46e5', textDecoration: 'none', '&:hover': { color: '#4338ca' } },
                                code: { color: '#ec4899', backgroundColor: '#fdf2f8', padding: '0.2em 0.4em', borderRadius: '0.25rem', fontWeight: '600', fontFamily: 'JetBrains Mono' },
                                pre: { backgroundColor: '#1e293b', color: '#e2e8f0', borderRadius: '1rem' },
                            },
                        },
                    }),
                }
            }
        }
    </script>
    <style>
        /* --- GLOBAL BACKGROUND --- */
        body {
            background-color: #f8fafc;
            background-image:
                    radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.08) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.05) 0px, transparent 50%),
                    radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.08) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;
            color: #1e293b;
        }

        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        [x-cloak] { display: none !important; }
        .tab-enter { animation: tabSlideIn 0.3s ease-out forwards; }
        @keyframes tabSlideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="antialiased font-sans flex flex-col min-h-screen">

<!-- HEADER (Fixed) -->
<div class="sticky top-0 z-50 shrink-0">
    <div th:replace="~{fragments/header :: header}"></div>
</div>

<!-- MAIN LAYOUT (Flex Row - Standard Scroll) -->
<div class="flex flex-1 relative items-start">

    <!-- SIDEBAR: LESSON LIST (Sticky under header) -->
    <aside class="w-full md:w-80 bg-white/80 backdrop-blur-xl border-r border-slate-200/60 flex-shrink-0 hidden md:flex flex-col z-20 sticky top-[74px] h-[calc(100vh-74px)] shadow-xl">
        <!-- Course Header -->
        <div class="p-5 border-b border-slate-100 bg-white/50 backdrop-blur-sm shrink-0">
            <a th:href="@{/my-courses}" class="text-xs font-bold text-slate-500 hover:text-brand-600 flex items-center mb-3 transition-colors uppercase tracking-wider group">
                <i class="fa-solid fa-arrow-left mr-2 transition-transform group-hover:-translate-x-1"></i>
                Quay l·∫°i kh√≥a h·ªçc
            </a>
            <h2 class="text-lg font-extrabold text-slate-900 leading-tight line-clamp-2" th:text="${course.name}">T√™n Kh√≥a h·ªçc</h2>

            <!-- Progress -->
            <div class="mt-3 w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                <div class="bg-gradient-to-r from-brand-500 to-purple-500 h-full rounded-full" style="width: 45%"></div>
            </div>
        </div>

        <!-- Lessons List (Scrollable inside sticky sidebar) -->
        <nav class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1">
            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-3 mt-2">N·ªôi dung kh√≥a h·ªçc</div>

            <ul class="space-y-1.5 pb-4">
                <li th:each="lesson : ${allLessons}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${lesson.id})}"
                       class="flex items-center p-3 rounded-xl transition-all duration-200 group relative overflow-hidden"
                       th:classappend="${lesson.id == currentLesson.id}
                                ? 'bg-gradient-to-r from-brand-50 to-white text-brand-700 shadow-sm ring-1 ring-brand-200 font-bold'
                                : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium'">

                        <div th:if="${lesson.id == currentLesson.id}" class="absolute left-0 top-0 bottom-0 w-1 bg-brand-500 rounded-l-xl"></div>

                        <span class="mr-3 text-lg flex items-center justify-center w-6 h-6 rounded-full transition-colors"
                              th:classappend="${lesson.id == currentLesson.id} ? 'text-brand-600 bg-brand-100' : 'text-slate-400 bg-slate-100 group-hover:text-slate-600'">
                                <i class="material-icons text-sm" th:switch="${lesson.lessonType?.name}">
                                    <span th:case="'Video'">play_arrow</span>
                                    <span th:case="'Quiz'">quiz</span>
                                    <span th:case="'Lab'">code</span>
                                    <span th:case="*">article</span>
                                </i>
                            </span>

                        <span class="flex-1 text-sm truncate" th:text="${lesson.name}">B√†i h·ªçc</span>
                        <i th:if="${lesson.id == currentLesson.id}" class="fa-solid fa-chart-simple text-brand-500 text-xs animate-pulse ml-2"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 bg-slate-50/50 min-h-[calc(100vh-74px)]">
        <!-- Background Decor -->
        <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none -z-10">
            <div class="absolute top-20 right-20 w-[500px] h-[500px] bg-brand-400/5 rounded-full blur-[100px]"></div>
            <div class="absolute bottom-20 left-20 w-[500px] h-[500px] bg-purple-400/5 rounded-full blur-[100px]"></div>
        </div>

        <div class="max-w-5xl mx-auto p-4 md:p-8 pb-32">

            <!-- Lesson Title -->
            <h1 class="text-2xl md:text-3xl font-black text-slate-900 mb-6 leading-tight flex items-start gap-3" data-aos="fade-down">
                <span class="text-brand-600 mt-1"><i class="fa-regular fa-circle-play"></i></span>
                <span th:text="${currentLesson.name}">T√™n b√†i h·ªçc</span>
            </h1>

            <!-- Tabs & Content -->
            <div x-data="{ activeTab: 'content' }" class="flex flex-col gap-6">

                <!-- Navigation -->
                <div class="flex space-x-2 border-b border-slate-200/60 pb-1" data-aos="fade-right">
                    <button @click="activeTab = 'content'"
                            :class="activeTab === 'content'
                                    ? 'text-brand-600 border-b-2 border-brand-600 bg-brand-50/50'
                                    : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50 border-transparent'"
                            class="px-6 py-2.5 rounded-t-lg font-bold text-sm transition-all flex items-center gap-2">
                        <i class="fa-solid fa-book-open"></i> B√†i h·ªçc
                    </button>
                    <button @click="activeTab = 'notes'; loadNotes()"
                            :class="activeTab === 'notes'
                                    ? 'text-brand-600 border-b-2 border-brand-600 bg-brand-50/50'
                                    : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50 border-transparent'"
                            class="px-6 py-2.5 rounded-t-lg font-bold text-sm transition-all flex items-center gap-2">
                        <i class="fa-solid fa-note-sticky"></i> Ghi ch√∫
                    </button>
                </div>

                <!-- TAB 1: CONTENT -->
                <div x-show="activeTab === 'content'" x-cloak class="tab-enter space-y-8">

                    <!-- Video -->
                    <div th:if="${currentLesson.videoUrl != null and !currentLesson.videoUrl.isEmpty()}"
                         class="rounded-2xl overflow-hidden shadow-2xl shadow-brand-900/20 border border-slate-200 bg-black relative group">
                        <div class="video-container">
                            <iframe th:src="${currentLesson.videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>

                    <!-- HTML Content -->
                    <div th:if="${currentLesson.htmlContent != null and !currentLesson.htmlContent.isEmpty()}"
                         class="prose prose-lg prose-slate max-w-none bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100"
                         th:utext="${currentLesson.htmlContent}">
                    </div>
                </div>

                <!-- TAB 2: NOTES -->
                <div x-show="activeTab === 'notes'" x-cloak class="tab-enter">
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 p-6 md:p-8">
                        <h3 class="text-xl font-bold mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-pen-to-square text-brand-500"></i> Ghi ch√∫ c·ªßa b·∫°n
                        </h3>

                        <div class="space-y-4">
                                <textarea id="note-content" rows="5"
                                          class="w-full p-4 rounded-xl border-slate-200 bg-slate-50 text-slate-700 text-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none transition-all resize-none shadow-inner placeholder-slate-400 font-medium"
                                          placeholder="Vi·∫øt ghi ch√∫ t·∫°i ƒë√¢y..."></textarea>

                            <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                                <button id="btn-ai-summary" onclick="getAiSummary()"
                                        class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2.5 text-xs font-bold text-brand-600 bg-brand-50 border border-brand-100 hover:bg-brand-100 rounded-xl transition-all gap-2">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI T√≥m t·∫Øt b√†i h·ªçc
                                </button>
                                <button id="btn-save-note" onclick="saveNote()"
                                        class="w-full sm:w-auto px-6 py-2.5 bg-brand-600 text-white font-bold text-xs rounded-xl hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-floppy-disk"></i> L∆∞u Ghi ch√∫
                                </button>
                            </div>
                        </div>

                        <div class="mt-8 border-t border-slate-100 pt-6">
                            <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Danh s√°ch ghi ch√∫</h4>
                            <div id="notes-list" class="space-y-4">
                                <div class="animate-pulse flex space-x-4">
                                    <div class="flex-1 space-y-2 py-1">
                                        <div class="h-2 bg-slate-200 rounded"></div>
                                        <div class="h-2 bg-slate-200 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Nav -->
            <div class="mt-12 flex justify-between items-center pt-8 border-t border-slate-200">
                <div th:if="${prevLesson != null}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${prevLesson.id})}"
                       class="group flex items-center gap-4 px-5 py-3 bg-white border border-slate-200 rounded-2xl shadow-sm hover:border-brand-200 hover:shadow-md transition-all">
                        <div class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center group-hover:bg-brand-50 group-hover:text-brand-600 transition-colors">
                            <i class="fa-solid fa-chevron-left"></i>
                        </div>
                        <div class="text-left hidden sm:block">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">B√†i tr∆∞·ªõc</div>
                            <div class="text-sm font-bold text-slate-700 group-hover:text-brand-700 max-w-[150px] truncate" th:text="${prevLesson.name}">Name</div>
                        </div>
                    </a>
                </div>
                <div th:if="${prevLesson == null}"></div>

                <div th:if="${nextLesson != null}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${nextLesson.id})}"
                       class="group flex items-center gap-4 px-5 py-3 bg-white border border-slate-200 rounded-2xl shadow-sm hover:border-brand-200 hover:shadow-md transition-all">
                        <div class="text-right hidden sm:block">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">B√†i ti·∫øp theo</div>
                            <div class="text-sm font-bold text-slate-700 group-hover:text-brand-700 max-w-[150px] truncate" th:text="${nextLesson.name}">Name</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center group-hover:bg-brand-600 group-hover:text-white transition-colors">
                            <i class="fa-solid fa-chevron-right"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- FOOTER (Standard Position) -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- ================= AI CHAT WIDGET (Glass Popup) ================= -->
<div class="fixed bottom-6 right-6 z-50 flex flex-col items-end pointer-events-none">
    <!-- Chat Window -->
    <div id="ai-chat-window" class="pointer-events-auto bg-white/90 backdrop-blur-xl w-[380px] h-[550px] rounded-[1.5rem] shadow-2xl border border-white/50 mb-4 transform transition-all duration-300 translate-y-10 opacity-0 invisible flex flex-col overflow-hidden ring-1 ring-slate-900/5 font-sans origin-bottom-right">
        <div class="bg-gradient-to-r from-brand-600 to-indigo-600 px-5 py-4 flex items-center justify-between cursor-pointer shadow-md" id="header-chat">
            <div class="flex items-center space-x-3">
                <div class="w-9 h-9 rounded-full bg-white/20 flex items-center justify-center text-lg backdrop-blur-sm border border-white/20 shadow-inner">ü§ñ</div>
                <div>
                    <h4 class="font-bold text-sm text-white">Tr·ª£ l√Ω CodeCampus</h4>
                    <div class="flex items-center space-x-1.5">
                        <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse shadow-[0_0_5px_rgba(52,211,153,0.8)]"></span>
                        <span class="text-[10px] text-white/90 font-medium">H·ªó tr·ª£ b√†i h·ªçc</span>
                    </div>
                </div>
            </div>
            <button id="closeChatBtn" class="text-white/70 hover:text-white hover:bg-white/10 p-2 rounded-lg transition-colors">
                <i class="fa-solid fa-chevron-down"></i>
            </button>
        </div>
        <div id="chatHistory" class="flex-1 bg-slate-50/50 p-4 overflow-y-auto custom-scrollbar space-y-4 scroll-smooth">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs shrink-0 text-slate-700 shadow-sm">ü§ñ</div>
                <div class="flex flex-col space-y-1 max-w-[85%]">
                    <div class="bg-white text-slate-700 px-4 py-3 rounded-2xl rounded-tl-none text-sm shadow-sm border border-slate-100 font-medium leading-relaxed">
                        Ch√†o b·∫°n! üëã M√¨nh l√† AI h·ªó tr·ª£ h·ªçc t·∫≠p.<br>N·∫øu g·∫∑p kh√≥ khƒÉn ho·∫∑c c·∫ßn g·ª£i √Ω, c·ª© h·ªèi m√¨nh nh√©!
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 bg-white border-t border-slate-100 shrink-0">
            <div class="relative flex items-center gap-2">
                <input type="text" id="chatInput" placeholder="H·ªèi v·ªÅ b√†i h·ªçc..." autocomplete="off" spellcheck="false" aria-label="Chat Input"
                       class="w-full bg-slate-100 text-slate-800 text-sm rounded-xl py-3 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:bg-white transition-all placeholder-slate-400">
                <button id="chatSendBtn" class="p-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg disabled:opacity-50"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>
    <!-- Button -->
    <button id="aiFloatButton" class="pointer-events-auto group relative flex items-center justify-center w-14 h-14 bg-gradient-to-br from-brand-600 to-indigo-600 text-white rounded-full shadow-lg hover:shadow-brand-500/50 transition-all duration-300 animate-float hover:scale-110 border-2 border-white z-50">
        <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
        <span class="absolute top-0 right-0 flex h-3.5 w-3.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3.5 w-3.5 bg-red-500 border-2 border-white"></span></span>
    </button>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script th:inline="javascript">
    AOS.init({ once: true, offset: 50, duration: 800 });

    /* VARIABLES */
    const LESSON_ID = /*[[${currentLesson.id}]]*/ null;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const headers = { 'Content-Type': 'application/json' };
    if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

    /* CHAT LOGIC */
    const aiBtn = document.getElementById('aiFloatButton');
    const chatWindow = document.getElementById('ai-chat-window');
    const closeChat = document.getElementById('closeChatBtn');
    const headerChat = document.getElementById('header-chat');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('chatSendBtn');
    const chatHistory = document.getElementById('chatHistory');

    function toggleChat() {
        if (chatWindow.classList.contains('invisible')) {
            chatWindow.classList.remove('invisible', 'opacity-0', 'translate-y-10');
            aiBtn.classList.add('opacity-0', 'scale-0');
            setTimeout(() => chatInput.focus(), 300);
        } else {
            chatWindow.classList.add('opacity-0', 'translate-y-10');
            aiBtn.classList.remove('opacity-0', 'scale-0');
            setTimeout(() => chatWindow.classList.add('invisible'), 300);
        }
    }

    aiBtn.onclick = toggleChat;
    closeChat.onclick = toggleChat;
    headerChat.onclick = (e) => { if(!e.target.closest('button')) toggleChat() };

    function addMessage(text, isUser) {
        const div = document.createElement('div');
        div.className = `flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''} message-enter`;
        const avatar = isUser ? '' : `<div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs shrink-0 text-slate-700 shadow-sm mt-1">ü§ñ</div>`;
        const bubble = isUser ? 'bg-brand-600 text-white rounded-2xl rounded-tr-none shadow-md shadow-brand-500/20' : 'bg-white text-slate-700 rounded-2xl rounded-tl-none shadow-sm border border-slate-200/60 font-medium';
        div.innerHTML = `${avatar}<div class="max-w-[85%]"><div class="${bubble} px-4 py-2.5 text-sm leading-relaxed">${text}</div></div>`;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function sendChat() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        addMessage(msg, true);
        chatInput.value = '';
        sendBtn.disabled = true;

        // Loading
        const loadingId = 'loading-' + Date.now();
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'flex items-start gap-3 message-enter';
        loadingDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs">ü§ñ</div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm flex gap-1"><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-75"></span><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-150"></span></div>`;
        chatHistory.appendChild(loadingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        try {
            const res = await fetch('/learning/api/ask-ai', { method: 'POST', headers, body: JSON.stringify({ lessonId: LESSON_ID, question: msg }) });
            document.getElementById(loadingId).remove();
            if (res.ok) {
                const data = await res.json();
                addMessage(data.answer, false);
            } else { addMessage("L·ªói k·∫øt n·ªëi.", false); }
        } catch (e) {
            document.getElementById(loadingId).remove();
            addMessage("L·ªói m·∫°ng.", false);
        } finally { sendBtn.disabled = false; }
    }
    sendBtn.onclick = sendChat;
    chatInput.onkeydown = (e) => { if(e.key === 'Enter') sendChat() };

    /* NOTES LOGIC */
    async function loadNotes() {
        const list = document.getElementById('notes-list');
        list.innerHTML = '<div class="text-center py-4 text-slate-400 text-sm italic">ƒêang t·∫£i ghi ch√∫...</div>';
        try {
            const res = await fetch(`/learning/api/notes/${LESSON_ID}`);
            const notes = await res.json();
            list.innerHTML = '';
            if (notes.length === 0) list.innerHTML = '<div class="text-center py-6 border-2 border-dashed border-slate-100 rounded-xl"><p class="text-slate-400 text-sm">Ch∆∞a c√≥ ghi ch√∫ n√†o.</p></div>';
            else {
                notes.forEach(note => {
                    const el = document.createElement('div');
                    el.id = `note-${note.id}`;
                    el.className = 'group bg-slate-50 p-4 rounded-xl border border-slate-100 hover:bg-white hover:shadow-sm hover:border-brand-100 transition-all';
                    el.innerHTML = `
                            <div class="note-view">
                                <p class="text-slate-700 text-sm whitespace-pre-wrap leading-relaxed">${escapeHtml(note.note)}</p>
                                <div class="flex justify-end gap-3 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="editNote(${note.id})" class="text-xs font-bold text-brand-600 hover:text-brand-800 flex items-center gap-1"><i class="fa-solid fa-pen"></i> S·ª≠a</button>
                                    <button onclick="deleteNote(${note.id})" class="text-xs font-bold text-red-500 hover:text-red-700 flex items-center gap-1"><i class="fa-solid fa-trash"></i> X√≥a</button>
                                </div>
                            </div>
                            <div class="note-edit hidden space-y-2">
                                <textarea class="w-full p-3 text-sm border border-brand-200 rounded-lg focus:ring-2 focus:ring-brand-500/20 outline-none bg-white" rows="3">${escapeHtml(note.note)}</textarea>
                                <div class="flex justify-end gap-2">
                                    <button onclick="cancelEditNote(${note.id})" class="px-3 py-1.5 text-xs font-bold text-slate-500 bg-slate-100 rounded-lg hover:bg-slate-200">H·ªßy</button>
                                    <button onclick="saveEditNote(${note.id})" class="px-3 py-1.5 text-xs font-bold text-white bg-brand-600 rounded-lg hover:bg-brand-700 shadow-sm">L∆∞u</button>
                                </div>
                            </div>`;
                    list.appendChild(el);
                });
            }
        } catch (e) { list.innerHTML = '<p class="text-red-500 text-sm text-center">L·ªói t·∫£i ghi ch√∫.</p>'; }
    }

    async function saveNote() {
        const content = document.getElementById('note-content').value.trim();
        if (!content) return;
        try {
            const res = await fetch('/learning/api/notes/save', { method: 'POST', headers, body: JSON.stringify({ lessonId: LESSON_ID, content }) });
            if (res.ok) { document.getElementById('note-content').value = ''; loadNotes(); }
        } catch (e) { alert('L·ªói l∆∞u ghi ch√∫'); }
    }

    async function getAiSummary() {
        const btn = document.getElementById('btn-ai-summary');
        const area = document.getElementById('note-content');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang t√≥m t·∫Øt...';
        try {
            const res = await fetch(`/learning/api/summarize/${LESSON_ID}`);
            const data = await res.json();
            area.value = data.summary;
        } catch (e) { alert('L·ªói AI'); }
        finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> AI T√≥m t·∫Øt b√†i h·ªçc'; }
    }

    function editNote(id) { document.getElementById(`note-${id}`).querySelector('.note-view').classList.add('hidden'); document.getElementById(`note-${id}`).querySelector('.note-edit').classList.remove('hidden'); }
    function cancelEditNote(id) { document.getElementById(`note-${id}`).querySelector('.note-view').classList.remove('hidden'); document.getElementById(`note-${id}`).querySelector('.note-edit').classList.add('hidden'); }
    async function saveEditNote(id) {
        const content = document.getElementById(`note-${id}`).querySelector('textarea').value;
        try { const res = await fetch(`/learning/api/notes/update/${id}`, { method: 'PUT', headers, body: JSON.stringify({ content }) }); if (res.ok) loadNotes(); } catch (e) { alert('L·ªói c·∫≠p nh·∫≠t'); }
    }
    async function deleteNote(id) {
        if (!confirm('X√≥a ghi ch√∫?')) return;
        try { const res = await fetch(`/learning/api/notes/${id}`, { method: 'DELETE', headers }); if (res.ok) document.getElementById(`note-${id}`).remove(); } catch (e) { alert('L·ªói x√≥a'); }
    }
    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
</script>
</body>
</html>