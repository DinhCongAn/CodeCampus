<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf}"/>

    <title>B√†i h·ªçc: <span th:text="${currentLesson.name}"></span></title>

    <!-- Tailwind CSS & Config (ƒê·ªìng b·ªô v·ªõi Home/Lab) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        light: { bg: '#f8fafc', card: '#ffffff', text: '#0f172a', muted: '#64748b' },
                        brand: { primary: '#4f46e5', secondary: '#7c3aed' }
                    },
                    boxShadow: {
                        'soft-xl': '0 20px 40px -10px rgba(0, 0, 0, 0.08), 0 10px 20px -10px rgba(79, 70, 229, 0.05)',
                        'glow-light': '0 0 20px rgba(79, 70, 229, 0.15)',
                        'float': '0 10px 30px -5px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Manrope', sans-serif; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Lesson Content Styles */
        .lesson-content h1 { font-size: 1.5em; font-weight: bold; margin-top: 1em;}
        .lesson-content h2 { font-size: 1.25em; font-weight: bold; margin-top: 0.8em;}
        .lesson-content p { margin-bottom: 1em; line-height: 1.6;}
        .lesson-content code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; }
        .lesson-content pre { background-color: #2d2d2d; color: #f8f8f2; padding: 1em; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; }

        /* Chat & UI Styles */
        .chat-link { color: #2563eb; text-decoration: underline; font-weight: 500; word-break: break-all; }
        .chat-link:hover { color: #1d4ed8; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

        /* Animations */
        @keyframes floating { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
        .animate-float { animation: floating 4s ease-in-out infinite; }

        /* Tab Styles */
        [x-cloak] { display: none; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; font-weight: 700; }
    </style>
    <script src="//unpkg.com/alpinejs" defer></script>
</head>

<div th:replace="~{fragments/header :: header}"></div>

<body class="bg-gray-50 text-slate-800">

<div class="flex h-screen">

    <aside class="w-full md:w-80 bg-white border-r border-gray-200 flex-shrink-0 md:h-screen md:sticky md:top-0 flex flex-col z-20 shadow-sm">
        <div class="p-5 border-b border-gray-100 bg-white">
            <a th:href="@{/my-courses}" class="text-sm text-gray-500 hover:text-indigo-600 flex items-center mb-3 transition-colors font-semibold">
                <span class="material-icons text-sm mr-1">arrow_back</span>
                Quay l·∫°i kh√≥a h·ªçc
            </a>
            <h2 class="text-lg font-extrabold text-slate-900 leading-tight" th:text="${course.name}">T√™n Kh√≥a h·ªçc</h2>
        </div>

        <nav class="flex-1 overflow-y-auto custom-scrollbar p-3">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 px-3">N·ªôi dung kh√≥a h·ªçc</div>
            <ul class="space-y-1">
                <li th:each="lesson : ${allLessons}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${lesson.id})}"
                       class="flex items-center p-3 rounded-xl transition-all duration-200 group"
                       th:classappend="${lesson.id == currentLesson.id} ? 'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200 font-bold' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium'">
                        <span class="material-icons mr-3 text-xl transition-colors"
                              th:classappend="${lesson.id == currentLesson.id} ? 'text-indigo-600' : 'text-slate-400 group-hover:text-slate-600'"
                              th:switch="${lesson.lessonType?.name}">
                            <span th:case="'Video'">play_circle</span>
                            <span th:case="'Quiz'">assignment</span>
                            <span th:case="'Lab'">science</span>
                            <span th:case="*">description</span>
                        </span>
                        <span class="flex-1 text-sm truncate" th:text="${lesson.name}">B√†i h·ªçc</span>
                        <span th:if="${lesson.id == currentLesson.id}" class="w-2 h-2 rounded-full bg-indigo-500 ml-2 animate-pulse"></span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <main class="flex-1 h-screen overflow-y-auto bg-gray-50 custom-scrollbar">
        <div class="p-8 max-w-4xl mx-auto pb-24"> <!-- Th√™m pb-24 ƒë·ªÉ tr√°nh n·ªôi dung b·ªã che b·ªüi chat -->
            <h1 class="text-3xl font-black text-slate-900 mb-6 leading-tight" th:text="${currentLesson.name}"></h1>

            <div x-data="{ activeTab: 'content' }">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8">
                        <button @click="activeTab = 'content'"
                                :class="{ 'active': activeTab === 'content' }"
                                class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 transition-colors text-sm font-medium uppercase tracking-wide">
                            N·ªôi dung b√†i h·ªçc
                        </button>
                        <button @click="activeTab = 'notes'; loadNotes()"
                                :class="{ 'active': activeTab === 'notes' }"
                                class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300 transition-colors text-sm font-medium uppercase tracking-wide">
                            Ghi ch√∫ c·ªßa t√¥i
                        </button>
                    </nav>
                </div>

                <div x-show="activeTab === 'content'" x-cloak>
                    <div th:if="${currentLesson.videoUrl != null and !currentLesson.videoUrl.isEmpty()}"
                         class="video-container rounded-xl overflow-hidden shadow-lg border border-gray-200">
                        <iframe th:src="${currentLesson.videoUrl}" frameborder="0" allowfullscreen></iframe>
                    </div>
                    <div th:if="${currentLesson.htmlContent != null and !currentLesson.htmlContent.isEmpty()}"
                         class="lesson-content mt-6 p-8 bg-white rounded-xl shadow-sm border border-gray-100 text-slate-700"
                         th:utext="${currentLesson.htmlContent}">
                    </div>
                </div>

                <div x-show="activeTab === 'notes'" x-cloak>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-xl font-bold mb-4 text-slate-800">Ghi ch√∫ c√° nh√¢n</h3>

                        <div>
                            <textarea id="note-content" rows="6" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 focus:outline-none transition-all bg-slate-50 text-sm"
                                      placeholder="Vi·∫øt ghi ch√∫ c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>

                            <div class="flex justify-between items-center mt-4">
                                <button id="btn-ai-summary" onclick="getAiSummary()"
                                        class="inline-flex items-center px-4 py-2 text-sm font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                                    <span class="material-icons mr-2 text-sm">auto_awesome</span>
                                    AI T√≥m t·∫Øt b√†i h·ªçc
                                </button>
                                <button id="btn-save-note" onclick="saveNote()"
                                        class="px-6 py-2 bg-indigo-600 text-white font-bold text-sm rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-transform transform hover:-translate-y-0.5">
                                    L∆∞u Ghi ch√∫
                                </button>
                            </div>
                        </div>

                        <div class="mt-8 border-t border-gray-100 pt-6">
                            <h4 class="text-lg font-bold mb-4 text-slate-700">C√°c ghi ch√∫ ƒë√£ l∆∞u</h4>
                            <div id="notes-list" class="space-y-4">
                                <p id="notes-loading" class="text-slate-400 text-sm">ƒêang t·∫£i ghi ch√∫...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 flex justify-between items-center pt-6 border-t border-gray-200">
                <div th:if="${prevLesson != null}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${prevLesson.id})}"
                       class="group flex items-center px-5 py-3 bg-white border border-gray-200 rounded-xl shadow-sm text-slate-600 hover:text-indigo-600 hover:border-indigo-200 hover:shadow-md transition-all duration-200">
                        <span class="material-icons mr-3 text-slate-400 group-hover:text-indigo-500 transition-colors">arrow_back</span>
                        <div class="text-left">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">B√†i tr∆∞·ªõc</div>
                            <div class="text-sm font-bold" th:text="${prevLesson.name}">T√™n b√†i tr∆∞·ªõc</div>
                        </div>
                    </a>
                </div>
                <div th:if="${prevLesson == null}"></div>

                <div th:if="${nextLesson != null}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${nextLesson.id})}"
                       class="group flex items-center px-5 py-3 bg-white border border-gray-200 rounded-xl shadow-sm text-slate-600 hover:text-indigo-600 hover:border-indigo-200 hover:shadow-md transition-all duration-200">
                        <div class="text-right mr-3">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">B√†i ti·∫øp</div>
                            <div class="text-sm font-bold" th:text="${nextLesson.name}">T√™n b√†i sau</div>
                        </div>
                        <span class="material-icons text-slate-400 group-hover:text-indigo-500 transition-colors">arrow_forward</span>
                    </a>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- ================= AI CHAT WIDGET (POPUP STYLE - UNIFIED) ================= -->
<div class="fixed bottom-6 right-6 z-50 flex flex-col items-end pointer-events-none">

    <!-- Chat Window Popup -->
    <div id="ai-chat-window" class="pointer-events-auto bg-white w-[380px] h-[600px] rounded-2xl shadow-2xl border border-slate-200 mb-4 transform transition-all duration-300 translate-y-10 opacity-0 invisible flex flex-col overflow-hidden ring-1 ring-black/5 font-sans">
        <!-- Header -->
        <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-slate-100 cursor-pointer" id="header-chat">
            <div class="flex items-center space-x-3">
                <div class="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center border border-emerald-200 text-lg shadow-sm">
                    ü§ñ
                </div>
                <div>
                    <h4 class="font-bold text-sm text-slate-800">Tr·ª£ l√Ω CodeCampus</h4>
                    <div class="flex items-center space-x-1.5">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                        <span class="text-[11px] text-slate-500 font-medium">H·ªó tr·ª£ b√†i h·ªçc</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-1">
                <button id="closeChatBtn" class="text-slate-400 hover:text-slate-700 hover:bg-slate-100 p-2 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chatHistory" class="flex-1 bg-white p-4 overflow-y-auto custom-scrollbar space-y-5 scroll-smooth">
            <!-- Intro Message -->
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-full bg-emerald-100 border border-emerald-200 flex items-center justify-center text-xs shrink-0 text-emerald-700 mt-1">ü§ñ</div>
                <div class="flex flex-col space-y-1 max-w-[90%] items-start">
                    <div class="bg-slate-100 text-slate-800 px-4 py-3 rounded-2xl rounded-tl-sm shadow-sm border border-slate-200/50 text-[14px] leading-relaxed">
                        Ch√†o b·∫°n! üëã M√¨nh l√† AI h·ªó tr·ª£ h·ªçc t·∫≠p.<br>
                        N·∫øu c√≥ th·∫Øc m·∫Øc v·ªÅ n·ªôi dung b√†i h·ªçc, ƒë·ª´ng ng·∫ßn ng·∫°i h·ªèi m√¨nh nh√©!
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-slate-100 shrink-0">
            <div class="relative flex items-end gap-2">
                <div class="relative w-full">
                    <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u h·ªèi v·ªÅ b√†i h·ªçc..."
                           class="w-full bg-slate-50 text-slate-800 text-sm rounded-xl py-3.5 pl-4 pr-10 focus:outline-none focus:ring-1 focus:ring-slate-300 focus:bg-white transition-all placeholder-slate-400 border border-slate-200 shadow-inner">
                </div>
                <button id="chatSendBtn" class="p-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
            <div class="text-center mt-2">
                <span class="text-[10px] text-slate-400">AI c√≥ th·ªÉ tr·∫£ l·ªùi sai. H√£y ki·ªÉm tra l·∫°i th√¥ng tin quan tr·ªçng.</span>
            </div>
        </div>
    </div>

    <!-- Floating Toggle Button -->
    <button id="aiFloatButton" class="pointer-events-auto group relative flex items-center justify-center w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl hover:shadow-indigo-500/40 transition-all duration-300 animate-float border border-white/20 hover:scale-110">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
        <span class="absolute top-0 right-0 flex h-3.5 w-3.5">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3.5 w-3.5 bg-red-500 border-2 border-white"></span>
        </span>
    </button>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
    /* L·∫•y c√°c bi·∫øn t·ª´ Thymeleaf */
    const LESSON_ID = /*[[${currentLesson.id}]]*/ null;
    const USER_ID = /*[[${currentUserId}]]*/ null;

    /* L·∫•y CSRF token */
    const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]')?.content;
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;

    const headers = { 'Content-Type': 'application/json' };
    if (csrfHeaderName && csrfToken) { headers[csrfHeaderName] = csrfToken; }

    // ================= CHAT LOGIC (VANILLA JS) =================

    // 1. UI Elements
    const aiBtn = document.getElementById('aiFloatButton');
    const chatWindow = document.getElementById('ai-chat-window');
    const closeBtn = document.getElementById('closeChatBtn');
    const headerChat = document.getElementById('header-chat');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatHistory = document.getElementById('chatHistory');

    // 2. Toggle Chat
    function toggleChat() {
        if (chatWindow.classList.contains('invisible')) {
            // Open
            chatWindow.classList.remove('invisible', 'opacity-0', 'translate-y-10');
            aiBtn.classList.add('opacity-0', 'scale-0');
            setTimeout(() => chatInput.focus(), 300);
        } else {
            // Close
            chatWindow.classList.add('opacity-0', 'translate-y-10');
            aiBtn.classList.remove('opacity-0', 'scale-0');
            setTimeout(() => chatWindow.classList.add('invisible'), 300);
        }
    }

    aiBtn.onclick = toggleChat;
    closeBtn.onclick = toggleChat;
    headerChat.addEventListener('click', (e) => {
        if (e.target === headerChat || e.target.closest('#header-chat')) {
            if (!chatWindow.classList.contains('invisible')) toggleChat();
        }
    });

    // 3. Helper Functions
    function formatMessageContent(text) {
        if(!text) return '';
        let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        safeText = safeText.replace(urlRegex, function(url) {
            return `<a href="${url}" target="_blank" class="chat-link">${url}</a>`;
        });
        safeText = safeText.replace(/\n/g, '<br>');
        return safeText;
    }

    function appendLoading() {
        const div = document.createElement('div');
        div.id = 'ai-loading';
        div.className = 'flex items-start gap-3 message-enter';
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-emerald-100 border border-emerald-200 flex items-center justify-center text-xs shrink-0 text-emerald-700 mt-1">ü§ñ</div>
            <div class="bg-slate-100 p-3 rounded-2xl rounded-tl-sm shadow-sm border border-slate-200/50 flex space-x-1 items-center h-10">
                <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span>
                <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            </div>`;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function addBubble(text, isUser) {
        const div = document.createElement('div');
        div.className = `flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''}`;
        const avatar = isUser ? '' : `<div class="w-8 h-8 rounded-full bg-emerald-100 border border-emerald-200 flex items-center justify-center text-xs shrink-0 text-emerald-700 mt-1">ü§ñ</div>`;
        const bubbleClass = isUser
            ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-sm shadow-md'
            : 'bg-slate-100 text-slate-800 rounded-2xl rounded-tl-sm shadow-sm border border-slate-200/50';

        const formattedContent = formatMessageContent(text);
        div.innerHTML = `
            ${avatar}
            <div class="flex flex-col space-y-1 max-w-[90%] ${isUser ? 'items-end' : 'items-start'}">
                <div class="${bubbleClass} px-4 py-3 text-[14px] leading-relaxed break-words">
                    ${formattedContent}
                </div>
            </div>`;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // 4. Send Message Logic
    const sendChat = async () => {
        const msg = chatInput.value.trim();
        if (!msg) return;

        addBubble(msg, true);
        chatInput.value = '';
        chatSendBtn.disabled = true;
        appendLoading();

        try {
            const response = await fetch('/learning/api/ask-ai', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    lessonId: LESSON_ID,
                    question: msg
                })
            });

            document.getElementById('ai-loading')?.remove();

            if (!response.ok) {
                addBubble("Xin l·ªói, t√¥i g·∫∑p l·ªói khi k·∫øt n·ªëi v·ªõi AI.", false);
            } else {
                const data = await response.json();
                addBubble(data.answer, false); // Backend tr·∫£ v·ªÅ { answer: ... }
            }
        } catch (error) {
            console.error("L·ªói g·ªçi API /api/ask-ai:", error);
            document.getElementById('ai-loading')?.remove();
            addBubble("L·ªói m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.", false);
        } finally {
            chatSendBtn.disabled = false;
        }
    };

    chatSendBtn.onclick = sendChat;
    chatInput.addEventListener('keydown', e => e.key === 'Enter' && sendChat());


    // ================= NOTES LOGIC (GI·ªÆ NGUY√äN) =================

    /** T·∫¢I DANH S√ÅCH GHI CH√ö */
    async function loadNotes() {
        const listDiv = document.getElementById('notes-list');
        listDiv.innerHTML = '<p id="notes-loading" class="text-slate-500 text-sm">ƒêang t·∫£i ghi ch√∫...</p>';

        try {
            const response = await fetch(`/learning/api/notes/${LESSON_ID}`);
            const notes = await response.json();

            listDiv.innerHTML = '';
            if (notes.length === 0) {
                listDiv.innerHTML = '<p class="text-slate-400 text-sm">B·∫°n ch∆∞a c√≥ ghi ch√∫ n√†o cho b√†i h·ªçc n√†y.</p>';
            } else {
                notes.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.id = `note-container-${note.id}`;
                    noteEl.className = 'p-4 bg-slate-50 border border-gray-200 rounded-xl';

                    noteEl.innerHTML = `
                        <div id="note-view-${note.id}">
                            <p class="text-slate-700 text-sm leading-relaxed" style="white-space: pre-wrap;">${escapeHTML(note.note)}</p>
                            <div class="flex justify-end space-x-3 mt-3">
                                <button onclick="showEditMode(${note.id})" class="text-xs font-bold text-indigo-600 hover:text-indigo-800">S·ª≠a</button>
                                <button onclick="deleteNote(${note.id})" class="text-xs font-bold text-red-500 hover:text-red-700">X√≥a</button>
                            </div>
                        </div>
                        <div id="note-edit-${note.id}" style="display:none;">
                            <textarea id="note-textarea-${note.id}" rows="4" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500">${escapeHTML(note.note)}</textarea>
                            <div class="flex justify-end space-x-2 mt-3">
                                <button onclick="cancelEdit(${note.id})" class="text-xs font-medium text-gray-500 hover:text-gray-700">H·ªßy</button>
                                <button onclick="updateNote(${note.id})" class="text-xs font-bold px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">L∆∞u</button>
                            </div>
                        </div>
                    `;
                    listDiv.appendChild(noteEl);
                });
            }
        } catch (error) {
            console.error('L·ªói t·∫£i ghi ch√∫:', error);
            listDiv.innerHTML = '<p class="text-red-500 text-sm">Kh√¥ng th·ªÉ t·∫£i ghi ch√∫.</p>';
        }
    }

    /** L∆ØU GHI CH√ö M·ªöI */
    async function saveNote() {
        const content = document.getElementById('note-content').value;
        if (!content.trim()) { alert('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫.'); return; }
        try {
            const response = await fetch('/learning/api/notes/save', {
                method: 'POST', headers: headers,
                body: JSON.stringify({ lessonId: LESSON_ID, content: content })
            });
            if (response.ok) {
                document.getElementById('note-content').value = '';
                loadNotes();
            } else { alert('L·ªói l∆∞u ghi ch√∫.'); }
        } catch (error) { console.error('L·ªói l∆∞u ghi ch√∫:', error); }
    }

    /** L·∫§Y T√ìM T·∫ÆT T·ª™ AI */
    async function getAiSummary() {
        const btn = document.getElementById('btn-ai-summary');
        const noteTextarea = document.getElementById('note-content');
        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons mr-2 text-sm animate-spin">refresh</span> ƒêang t√≥m t·∫Øt...';

        try {
            const response = await fetch(`/learning/api/summarize/${LESSON_ID}`);
            const data = await response.json();
            noteTextarea.value = data.summary;
        } catch (error) {
            console.error('L·ªói l·∫•y t√≥m t·∫Øt AI:', error);
            alert('Kh√¥ng th·ªÉ l·∫•y t√≥m t·∫Øt t·ª´ AI.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span class="material-icons mr-2 text-sm">auto_awesome</span> AI T√≥m t·∫Øt b√†i h·ªçc';
        }
    }

    /** HELPER FUNCTIONS */
    function showEditMode(noteId) {
        document.getElementById(`note-view-${noteId}`).style.display = 'none';
        document.getElementById(`note-edit-${noteId}`).style.display = 'block';
    }
    function cancelEdit(noteId) {
        document.getElementById(`note-view-${noteId}`).style.display = 'block';
        document.getElementById(`note-edit-${noteId}`).style.display = 'none';
    }
    async function deleteNote(noteId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y kh√¥ng?')) return;
        try {
            const response = await fetch(`/learning/api/notes/${noteId}`, { method: 'DELETE', headers: headers });
            if (response.ok) {
                document.getElementById(`note-container-${noteId}`).remove();
                const listDiv = document.getElementById('notes-list');
                if (!listDiv.hasChildNodes()) listDiv.innerHTML = '<p class="text-slate-400 text-sm">B·∫°n ch∆∞a c√≥ ghi ch√∫ n√†o cho b√†i h·ªçc n√†y.</p>';
            } else { alert('L·ªói: Kh√¥ng th·ªÉ x√≥a ghi ch√∫.'); }
        } catch (error) { console.error('L·ªói khi x√≥a ghi ch√∫:', error); }
    }
    async function updateNote(noteId) {
        const newContent = document.getElementById(`note-textarea-${noteId}`).value;
        if (!newContent.trim()) { alert('N·ªôi dung ghi ch√∫ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.'); return; }
        try {
            const response = await fetch(`/learning/api/notes/update/${noteId}`, {
                method: 'PUT', headers: headers, body: JSON.stringify({ content: newContent })
            });
            if (response.ok) {
                const updatedNote = await response.json();
                document.querySelector(`#note-view-${noteId} p`).textContent = updatedNote.note;
                cancelEdit(noteId);
            } else { alert('L·ªói: Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ghi ch√∫.'); }
        } catch (error) { console.error('L·ªói khi c·∫≠p nh·∫≠t ghi ch√∫:', error); }
    }
    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
</script>

</body>
</html>