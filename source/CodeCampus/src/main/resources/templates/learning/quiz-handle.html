<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf}"/>

    <title>Làm bài: <span th:text="${attempt.quiz.name}"></span></title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="//unpkg.com/alpinejs" defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none !important; }

        /* Custom Scrollbar cho bảng câu hỏi */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Trạng thái câu đã làm */
        .question-palette-btn.answered {
            background-color: #2563EB; /* blue-600 */
            color: white;
            border-color: #2563EB;
        }

        /* Hiệu ứng khi chọn đáp án */
        .quiz-option input:checked + div {
            border-color: #2563EB;
            background-color: #EFF6FF; /* blue-50 */
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1), 0 2px 4px -1px rgba(37, 99, 235, 0.06);
        }
        .quiz-option input:checked + div .radio-indicator {
            border-color: #2563EB;
            border-width: 6px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

<div th:replace="~{fragments/header :: header}"></div>

<div class="flex-grow py-8 px-4 sm:px-6 lg:px-8"
     x-data="quizApp()"
     th:attr="data-attempt-id=${attempt.id},
              data-start-time=${attempt.startTime},
              data-duration-minutes=${attempt.quiz.durationMinutes},
              data-questions=${questionsJson},
              data-saved-answers=${savedAnswersJson}"
     x-init="init()">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

        <main class="lg:col-span-8 xl:col-span-9 space-y-6">

            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <div>
                    <h2 class="text-lg font-bold text-slate-700">
                        Câu hỏi <span class="text-blue-600 text-2xl ml-1" x-text="currentQuestionIndex + 1"></span>
                        <span class="text-slate-400 text-lg" x-text="` / ${questions.length}`"></span>
                    </h2>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2 sm:w-64">
                        <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500"
                             :style="`width: ${((currentQuestionIndex + 1) / questions.length) * 100}%`"></div>
                    </div>
                </div>

                <button @click="getAiHint()"
                        class="group flex items-center px-4 py-2 bg-amber-50 text-amber-700 border border-amber-200 rounded-lg hover:bg-amber-100 hover:shadow-sm transition-all"
                        :disabled="isHintLoading">
                    <span class="material-icons text-xl mr-2 group-hover:text-amber-600"
                          :class="{'animate-spin': isHintLoading}">
                        lightbulb
                    </span>
                    <span class="font-semibold" x-text="isHintLoading ? 'Đang suy nghĩ...' : 'Bật kênh cố vấn AI'"></span>
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <div class="p-6 sm:p-8 border-b border-slate-100">
                    <div class="prose prose-slate max-w-none text-lg text-slate-800 leading-relaxed"
                         x-html="escapeHtml(currentQuestion.content)">
                    </div>
                </div>

                <div class="p-6 sm:p-8 bg-slate-50/50 space-y-4">
                    <template x-for="option in currentQuestion.answerOptions" :key="option.id">
                        <label class="quiz-option block cursor-pointer group relative">
                            <input type="radio"
                                   :name="`q_${currentQuestion.id}`"
                                   :value="option.id"
                                   @change="saveAnswer(currentQuestion.id, option.id)"
                                   x-model.number="selectedAnswers[currentQuestion.id]"
                                   class="peer sr-only"> <div class="p-5 rounded-lg border border-slate-200 bg-white transition-all hover:border-blue-300 hover:shadow-md flex items-start">
                            <div class="radio-indicator flex-shrink-0 h-6 w-6 rounded-full border-2 border-slate-300 mr-4 mt-0.5 transition-all bg-white"></div>

                            <div class="text-slate-700 text-lg select-none" x-html="escapeHtml(option.content)"></div>
                        </div>
                        </label>
                    </template>
                </div>

                <div class="bg-white px-6 py-4 border-t border-slate-200 flex justify-between items-center">
                    <button @click="prevQuestion()"
                            :disabled="currentQuestionIndex === 0"
                            class="flex items-center px-5 py-2.5 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-slate-900 disabled:opacity-40 disabled:hover:bg-transparent transition-colors font-medium">
                        <span class="material-icons mr-2">arrow_back</span>
                        Trước
                    </button>

                    <button @click="nextQuestion()"
                            x-show="currentQuestionIndex < questions.length - 1"
                            class="flex items-center px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:shadow-lg hover:-translate-y-0.5 transition-all font-medium shadow-md">
                        Sau
                        <span class="material-icons ml-2">arrow_forward</span>
                    </button>

                    <button @click="submitQuiz()"
                            x-show="currentQuestionIndex === questions.length - 1"
                            :disabled="isSubmitting"
                            class="flex items-center px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 hover:shadow-lg hover:-translate-y-0.5 transition-all font-medium shadow-md">
                        <span x-text="isSubmitting ? 'Đang xử lý...' : 'Nộp bài'"></span>
                        <span class="material-icons ml-2" x-show="!isSubmitting">check_circle</span>
                        <span class="material-icons ml-2 animate-spin" x-show="isSubmitting">refresh</span>
                    </button>
                </div>
            </div>
        </main>

        <aside class="lg:col-span-4 xl:col-span-3">
            <div class="sticky top-6 space-y-6">

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-slate-100">
                        <div class="h-full bg-red-500 transition-all duration-1000"
                             :style="`width: ${(timeLeftSeconds / (durationMinutes * 60)) * 100}%`"></div>
                    </div>
                    <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Thời gian còn lại</p>
                    <div class="text-4xl font-black tracking-tight"
                         :class="timeLeftSeconds < 300 ? 'text-red-600 animate-pulse' : 'text-slate-800'"
                         x-text="timerDisplay">
                        00:00
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col max-h-[60vh]">
                    <div class="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex justify-between items-center">
                        <h3 class="font-semibold text-slate-700">Danh sách câu hỏi</h3>
                        <span class="text-xs font-medium px-2 py-1 bg-blue-100 text-blue-700 rounded-full"
                              x-text="Object.keys(selectedAnswers).length + '/' + questions.length + ' đã làm'"></span>
                    </div>

                    <div class="p-4 overflow-y-auto custom-scrollbar flex-1">
                        <div class="grid grid-cols-5 gap-2">
                            <template x-for="(question, index) in questions" :key="question.id">
                                <button @click="goToQuestion(index)"
                                        class="question-palette-btn w-full aspect-square flex items-center justify-center text-sm font-medium rounded border transition-all duration-200"
                                        :class="{
                                            'answered': selectedAnswers[question.id] !== undefined,
                                            'ring-2 ring-offset-2 ring-blue-500 border-transparent': currentQuestionIndex === index,
                                            'bg-white text-slate-600 border-slate-200 hover:bg-slate-100 hover:border-slate-300': selectedAnswers[question.id] === undefined && currentQuestionIndex !== index
                                        }"
                                        x-text="index + 1">
                                </button>
                            </template>
                        </div>
                    </div>

                    <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl">
                        <button @click="submitQuiz()"
                                :disabled="isSubmitting"
                                class="w-full py-3 bg-white border-2 border-green-600 text-green-700 font-bold rounded-lg hover:bg-green-50 transition-colors shadow-sm flex items-center justify-center">
                            Nộp bài ngay
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <div x-show="showHintModal" x-transition.opacity
         class="fixed inset-0 bg-slate-900/75 backdrop-blur-sm flex items-center justify-center p-4 z-50" x-cloak>
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden transform transition-all"
             @click.away="showHintModal = false">
            <div class="bg-gradient-to-r from-amber-100 to-orange-50 p-6 border-b border-amber-100 flex items-center gap-3">
                <div class="p-2 bg-white rounded-full shadow-sm text-amber-500">
                    <span class="material-icons text-2xl">lightbulb</span>
                </div>
                <h3 class="text-xl font-bold text-amber-900">Bật kênh cố vấn AI</h3>
            </div>
            <div class="p-8">
                <div class="prose prose-slate max-w-none text-slate-600" x-text="hintContent"></div>
            </div>
            <div class="bg-slate-50 p-6 flex justify-end border-t border-slate-100">
                <button @click="showHintModal = false"
                        class="px-6 py-2 bg-slate-800 text-white font-medium rounded-lg hover:bg-slate-900 transition-colors">
                    Đã hiểu
                </button>
            </div>
        </div>
    </div>

</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
    // Cấu hình CSRF
    const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]')?.content;
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const httpHeaders = { 'Content-Type': 'application/json' };
    if (csrfHeaderName && csrfToken) httpHeaders[csrfHeaderName] = csrfToken;

    function quizApp() {
        return {
            attemptId: 0,
            questions: [],
            savedAnswers: {},
            startTime: null,
            durationMinutes: 0,

            currentQuestionIndex: 0,
            selectedAnswers: {},
            timerDisplay: '00:00',
            timeLeftSeconds: 0, // Thêm biến này để làm thanh progress thời gian
            timerInterval: null,
            isSubmitting: false,
            isHintLoading: false,
            showHintModal: false,
            hintContent: '',

            escapeHtml(str) {
                if (!str) return '';
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            },

            get currentQuestion() {
                if (!this.questions || this.questions.length === 0)
                    return { id: 0, content: 'Đang tải...', answerOptions: [] };
                return this.questions[this.currentQuestionIndex];
            },

            init() {
                const el = this.$el;
                this.attemptId = parseInt(el.dataset.attemptId);
                this.questions = JSON.parse(el.dataset.questions);
                this.savedAnswers = JSON.parse(el.dataset.savedAnswers);
                this.selectedAnswers = { ...this.savedAnswers };
                this.startTime = new Date(el.dataset.startTime);
                this.durationMinutes = parseInt(el.dataset.durationMinutes);
                this.startTimer();

                // Scroll to top on init if needed
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            nextQuestion() {
                if (this.currentQuestionIndex < this.questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.scrollToTop();
                }
            },
            prevQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.scrollToTop();
                }
            },
            goToQuestion(index) {
                this.currentQuestionIndex = index;
                this.scrollToTop();
            },
            scrollToTop() {
                // Cuộn nhẹ lên đầu phần câu hỏi (không phải đầu trang web)
                const main = document.querySelector('main');
                if(main) {
                    const y = main.getBoundingClientRect().top + window.scrollY - 100;
                    window.scrollTo({top: y, behavior: 'smooth'});
                }
            },

            startTimer() {
                const endTime = this.startTime.getTime() + this.durationMinutes * 60 * 1000;

                this.timerInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = endTime - now;
                    this.timeLeftSeconds = Math.floor(distance / 1000); // Lưu giây còn lại

                    if (distance < 0) {
                        clearInterval(this.timerInterval);
                        this.timerDisplay = "Hết giờ";
                        this.timeLeftSeconds = 0;
                        this.submitQuiz(true);
                    } else {
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        this.timerDisplay = String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');
                    }
                }, 1000);
            },

            async saveAnswer(questionId, answerId) {
                this.selectedAnswers[questionId] = answerId;
                try {
                    await fetch('/learning/attempt/api/save-answer', {
                        method: 'POST', headers: httpHeaders,
                        body: JSON.stringify({ attemptId: this.attemptId, questionId: questionId, answerId: answerId })
                    });
                } catch (e) { console.error("Lỗi lưu:", e); }
            },

            async getAiHint() {
                this.isHintLoading = true;
                this.hintContent = 'AI đang hack não để trả lời câu này…';
                this.showHintModal = true;
                try {
                    const res = await fetch(`/learning/attempt/api/hint/${this.attemptId}/${this.currentQuestion.id}`);
                    const data = await res.json();
                    this.hintContent = data.hint;
                } catch (e) {
                    this.hintContent = 'Lỗi kết nối AI.';
                } finally { this.isHintLoading = false; }
            },

            async submitQuiz(isAutoSubmit = false) {
                if (!isAutoSubmit && !confirm('Bạn có chắc chắn muốn nộp bài?')) return;
                this.isSubmitting = true;
                clearInterval(this.timerInterval);
                try {
                    const res = await fetch('/learning/attempt/api/submit', {
                        method: 'POST', headers: httpHeaders,
                        body: JSON.stringify({ attemptId: this.attemptId })
                    });
                    const data = await res.json();
                    window.location.href = data.reviewUrl;
                } catch (e) {
                    alert('Lỗi nộp bài.');
                    this.isSubmitting = false;
                }
            }
        }
    }
</script>
</body>
</html>