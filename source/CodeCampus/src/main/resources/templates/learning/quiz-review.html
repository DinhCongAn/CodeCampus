<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả Quiz: <span th:text="${review.quizName}"></span></title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="//unpkg.com/alpinejs" defer></script>
    <style>
        [x-cloak] { display: none; }
        .answer-correct { background-color: #F0FDF4; border-left: 4px solid #4ADE80; }
        .answer-incorrect { background-color: #FEF2F2; border-left: 4px solid #F87171; }
        .answer-neutral { border-left: 4px solid #E5E7EB; }
    </style>
</head>
<body class="bg-gray-100">

<div class.="container mx-auto max-w-4xl p-4 md:p-8 mt-10"
     x-data="aiReviewModals()">

    <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900" th:text="${review.quizName}"></h1>
                <p class="text-lg text-gray-500">Xem lại kết quả của bạn</p>
            </div>
            <div th:if="${review.result == 'Pass'}" class="mt-4 md:mt-0 px-6 py-3 bg-green-100 text-green-800 rounded-lg text-2xl font-bold">...</div>
            <div th:if="${review.result == 'Fail'}" class="mt-4 md:mt-0 px-6 py-3 bg-red-100 text-red-800 rounded-lg text-2xl font-bold">...</div>
        </div>
        <div class="grid grid-cols-2 gap-4 mt-6 text-center">
            <div class="p-4 bg-blue-50 rounded-lg">
                <span class="block text-3xl font-semibold text-blue-800" th:text="${#numbers.formatDecimal(review.score, 1, 1)} + ' / 100'"></span>
                <span class="text-sm text-gray-500">Điểm số</span>
            </div>
            <div class="p-4 bg-green-50 rounded-lg">
                <span class="block text-3xl font-semibold text-green-800" th:text="${review.correctCount} + ' / ' + ${review.totalQuestions}"></span>
                <span class="text-sm text-gray-500">Số câu đúng</span>
            </div>
        </div>

        <div class="mt-6 border-t pt-6">
            <button @click="loadAnalysis()"
                    class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition duration-300 text-lg flex items-center justify-center">
                <span class="material-icons mr-2">auto_awesome</span>
                AI Phân tích & Giải thích Lỗi sai
            </button>
        </div>
    </div>

    <div class="mt-8 space-y-6">
        <h2 class="text-2xl font-semibold text-gray-800">Chi tiết câu trả lời</h2>

        <div th:each="q, iter : ${review.questions}" class="bg-white rounded-lg shadow-lg overflow-hidden">

            <div class="p-6">
                <h3 class="text-lg font-semibold" th:text="|Câu ${iter.count}: ${q.content}|"></h3>
            </div>

            <div class="px-6 py-4" th:classappend="${q.isCorrect} ? 'answer-correct' : 'answer-incorrect'">
                <p class="text-sm font-medium text-gray-500">Bạn đã chọn:</p>
                <p class="text-gray-800" th:text="${q.userAnswerContent}"></p>
            </div>

            <div th:if="${!q.isCorrect}" class="px-6 py-4 answer-neutral">
                <p class="text-sm font-medium text-gray-500">Đáp án đúng:</p>
                <p class="text-gray-800 font-semibold" th:text="${q.correctAnswerContent}"></p>
            </div>

            <div class="px-6 py-4 bg-gray-50 border-t">
                <p class="text-sm font-medium text-gray-500">Giải thích:</p>

                <p th:if="${q.explanation != null and !q.explanation.isEmpty()}"
                   class="text-gray-700 mt-1" th:text="${q.explanation}"></p>

                <div th:if="${!q.isCorrect AND (q.explanation == null OR q.explanation.isEmpty())}">
                    <p class="text-gray-500 mt-1 italic">
                        (Bấm nút "AI Phân tích & Giải thích" ở trên để xem giải thích chi tiết)
                    </p>
                </div>

                <p th:if="${q.isCorrect}" class="text-gray-700 mt-1 italic">Chính xác!</p>
            </div>

        </div>
    </div>

    <div x-show="analysisModalOpen" @click.away="analysisModalOpen = false" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
            <h3 class="text-xl font-semibold flex items-center mb-4">
                <span class="material-icons text-blue-500 mr-2">auto_awesome</span>
                AI Phân tích & Giải thích
            </h3>

            <div class="max-h-96 overflow-y-auto space-y-4">

                <div x-show="isLoading" class="text-center text-gray-500">Đang phân tích...</div>

                <div x-show="!isLoading && analysisContent" class="p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-lg text-blue-800 mb-2">1. Nhận xét tổng quan</h4>
                    <p class="text-gray-700" style="white-space: pre-wrap;" x-text="analysisContent"></p>
                </div>

                <div x-show="!isLoading && explanationContent" class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-lg text-blue-800 mb-2">2. Giải thích chi tiết</h4>
                    <p class="text-gray-700" style="white-space: pre-wrap;" x-text="explanationContent"></p>
                </div>

                <div x-show="!isLoading && errorContent">
                    <p class="text-red-600" x-text="errorContent"></p>
                </div>
            </div>

            <button @click="analysisModalOpen = false" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">
                Đã hiểu
            </button>
        </div>
    </div>

</div>

<script th:inline="javascript">
    function aiReviewModals() {
        return {
            // Trạng thái
            isLoading: false,
            analysisModalOpen: false,

            // Biến chứa nội dung đã TÁCH
            analysisContent: '',
            explanationContent: '',
            errorContent: '', // Biến chứa lỗi

            async loadAnalysis() {
                this.isLoading = true;
                this.analysisModalOpen = true;
                // Xóa nội dung cũ
                this.analysisContent = '';
                this.explanationContent = '';
                this.errorContent = '';

                try {
                    const attemptId = /*[[${review.attemptId}]]*/ 0;
                    const response = await fetch(`/learning/review/api/analysis/${attemptId}`);
                    const data = await response.json();

                    if (!response.ok || data.analysis.includes('Lỗi:')) {
                        this.errorContent = data.analysis || 'Lỗi không xác định.';
                        return;
                    }

                    const fullText = data.analysis;

                    // === LOGIC TÁCH CHUỖI ===
                    // Tách chuỗi bằng "### " (dấu # của Markdown)
                    const parts = fullText.split('### ');

                    // parts[0] là lời chào
                    // parts[1] là "1. Nhận xét tổng quan..."
                    // parts[2] là "2. Giải thích chi tiết..." (cả phần kết)

                    if (parts.length >= 3) {
                        this.analysisContent = parts[1]
                            .replace('1. Nhận xét tổng quan', '') // Xóa tiêu đề
                            .trim();

                        // Tách phần kết luận ra khỏi phần giải thích
                        const explanationParts = parts[2]
                            .replace('2. Giải thích chi tiết', '') // Xóa tiêu đề
                            .split('---'); // Tách bằng dấu "---"

                        this.explanationContent = explanationParts[0].trim(); // Chỉ lấy phần trước dấu ---

                    } else if (fullText.includes('Tuyệt vời!')) {
                        // Trường hợp làm đúng hết
                        this.analysisContent = fullText;
                    }
                    else {
                        // Nếu AI trả về định dạng lạ, hiển thị tất cả
                        this.analysisContent = fullText;
                        this.explanationContent = 'Không thể tự động tách phần giải thích.';
                    }

                } catch (e) {
                    this.errorContent = 'Lỗi kết nối đến AI. Vui lòng thử lại.';
                } finally {
                    this.isLoading = false;
                }
            }
        }
    }
</script>

</body>
</html>