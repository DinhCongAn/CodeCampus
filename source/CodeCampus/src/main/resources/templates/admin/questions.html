<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Ngân hàng câu hỏi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin-style.css}">

    <style>
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none; /* Mặc định ẩn */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            backdrop-filter: blur(3px);
        }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-warning mb-3" role="status"></div>
    <h5 class="fw-bold">AI đang suy nghĩ và tạo câu hỏi...</h5>
    <p class="small text-white-50">Vui lòng không tắt trình duyệt.</p>
</div>

<div th:replace="~{fragments/sidebar-menu-admin :: sidebar('questions')}"></div>

<div class="main-content" id="mainContent">

    <div class="topbar d-flex align-items-center justify-content-between p-3 border-bottom bg-white shadow-sm">
        <div class="d-flex align-items-center">
            <button class="btn btn-light border shadow-sm me-3" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h4 class="mb-0 fw-bold text-primary">Ngân hàng câu hỏi</h4>
        </div>
        <div class="user-info">
            <span class="text-muted small">Admin</span>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show"><i class="fas fa-check-circle me-2"></i> <span th:text="${successMessage}"></span><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show"><i class="fas fa-exclamation-circle me-2"></i> <span th:text="${errorMessage}"></span><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body bg-light rounded">
                <form th:action="@{/admin/questions}" method="get" class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="small fw-bold text-muted">Từ khóa</label>
                        <input type="text" name="keyword" class="form-control" th:value="${keyword}" placeholder="Nội dung câu hỏi...">
                    </div>

                    <div class="col-md-3">
                        <label class="small fw-bold text-muted">Môn học</label>
                        <select name="courseId" class="form-select" onchange="loadQuizzes(this.value, 'filterQuizId')">
                            <option value="">-- Tất cả Môn --</option>
                            <option th:each="c : ${courses}" th:value="${c.id}" th:text="${c.name}" th:selected="${c.id == courseId}"></option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="small fw-bold text-muted">Bài kiểm tra (Quiz)</label>
                        <select name="quizId" id="filterQuizId" class="form-select">
                            <option value="">-- Tất cả Quiz --</option>
                            <option th:if="${quizId != null}" th:each="z : ${quizzes}"
                                    th:value="${z.id}" th:text="${z.name}" th:selected="${z.id == quizId}"></option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100 fw-bold"><i class="fas fa-filter me-1"></i> Lọc Dữ Liệu</button>
                    </div>
                </form>

                <hr class="my-3 text-muted opacity-25">
                <div class="text-end">
                    <button class="btn btn-success fw-bold shadow-sm" onclick="openModalAdd()">
                        <i class="fas fa-plus-circle me-1"></i> Thêm Câu Hỏi Mới
                    </button>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light table-light">
                    <tr>
                        <th class="ps-4">ID</th>
                        <th style="width: 40%;">Nội dung</th>
                        <th>Thuộc Quiz</th>
                        <th>Mức độ</th>
                        <th class="text-end pe-4">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${qPage.empty}"><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-box-open fa-2x mb-2"></i><br>Không tìm thấy câu hỏi nào.</td></tr>

                    <tr th:each="q : ${qPage.content}">
                        <td class="ps-4 fw-bold text-muted" th:text="${'#' + q.id}"></td>
                        <td>
                            <span class="d-block fw-bold text-dark text-wrap mb-1" th:text="${q.content}"></span>
                            <small class="text-success"><i class="fas fa-check-circle me-1"></i>
                                <span th:each="a:${q.answerOptions}" th:if="${a.correct}" th:text="${a.content}"></span>
                            </small>
                        </td>
                        <td>
                            <div th:if="${not #lists.isEmpty(q.quizzes)}">
                                <span th:each="z : ${q.quizzes}" class="badge bg-primary-subtle text-primary border border-primary-subtle me-1 mb-1" th:text="${z.name}"></span>
                            </div>
                            <span th:if="${#lists.isEmpty(q.quizzes)}" class="text-muted small">Chưa gán</span>
                        </td>
                        <td><span class="badge bg-light text-dark border" th:text="${q.questionLevel != null ? q.questionLevel.name : '-'}"></span></td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-primary" th:onclick="'editQuestion(' + ${q.id} + ')'" title="Sửa"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light" th:if="${qPage.totalPages > 0}">
                <span class="text-muted small">
                    Hiển thị <strong th:text="${qPage.numberOfElements}"></strong>
                    trên tổng số <strong th:text="${qPage.totalElements}"></strong> câu hỏi
                </span>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" th:classappend="${qPage.first ? 'disabled' : ''}">
                            <a class="page-link" th:href="@{/admin/questions(page=${qPage.number - 1}, keyword=${keyword}, courseId=${courseId}, quizId=${quizId}, levelId=${levelId})}">Trước</a>
                        </li>

                        <li class="page-item" th:each="i : ${#numbers.sequence(0, qPage.totalPages - 1)}"
                            th:classappend="${i == qPage.number ? 'active' : ''}"
                            th:if="${i == 0 or i == qPage.totalPages - 1 or (i >= qPage.number - 2 and i <= qPage.number + 2)}">

                            <a class="page-link" th:if="${i >= qPage.number - 2 and i <= qPage.number + 2}"
                               th:href="@{/admin/questions(page=${i}, keyword=${keyword}, courseId=${courseId}, quizId=${quizId}, levelId=${levelId})}"
                               th:text="${i + 1}">1</a>

                            <span class="page-link border-0 bg-transparent text-muted" th:if="${!(i >= qPage.number - 2 and i <= qPage.number + 2)}" th:text="${'...'}" ></span>
                        </li>

                        <li class="page-item" th:classappend="${qPage.last ? 'disabled' : ''}">
                            <a class="page-link" th:href="@{/admin/questions(page=${qPage.number + 1}, keyword=${keyword}, courseId=${courseId}, quizId=${quizId}, levelId=${levelId})}">Sau</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="questionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="modalTitle"><i class="fas fa-layer-group me-2"></i>Quản lý Câu Hỏi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="nav nav-tabs nav-fill bg-light" role="tablist">
                    <li class="nav-item"><button class="nav-link active rounded-0 py-3 fw-bold" data-bs-toggle="tab" data-bs-target="#manual-pane"><i class="fas fa-pen me-2"></i>Thủ Công</button></li>
                    <li class="nav-item"><button class="nav-link rounded-0 py-3 fw-bold" data-bs-toggle="tab" data-bs-target="#import-pane"><i class="fas fa-file-excel me-2"></i>Import Excel</button></li>
                    <li class="nav-item"><button class="nav-link rounded-0 py-3 fw-bold" data-bs-toggle="tab" data-bs-target="#ai-pane"><i class="fas fa-robot me-2 text-warning"></i>AI Tạo</button></li>
                </ul>

                <div class="tab-content p-4">

                    <div class="tab-pane fade show active" id="manual-pane">
                        <form th:action="@{/admin/questions/save}" method="post" id="manualForm">
                            <input type="hidden" name="id" id="questionId">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">1. Chọn Môn học</label>
                                    <select class="form-select bg-light" name="courseId" id="manualCourseId" onchange="loadQuizzes(this.value, 'manualQuizId')" required>
                                        <option value="">-- Chọn Môn --</option>
                                        <option th:each="c:${courses}" th:value="${c.id}" th:text="${c.name}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-primary">2. Thêm vào Quiz (Tự động)</label>
                                    <select class="form-select border-primary" name="quizId" id="manualQuizId">
                                        <option value="">-- Vui lòng chọn Môn trước --</option>
                                    </select>
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label fw-bold">Độ khó</label>
                                    <select class="form-select w-auto" name="levelId" id="levelId">
                                        <option th:each="l:${levels}" th:value="${l.id}" th:text="${l.name}"></option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold">Nội dung câu hỏi</label>
                                    <textarea class="form-control" name="content" id="content" rows="3" placeholder="Nhập câu hỏi..." required></textarea>
                                </div>

                                <div class="col-12 bg-light p-3 rounded border">
                                    <label class="fw-bold text-success mb-2"><i class="fas fa-check-square me-1"></i> ĐÁP ÁN (Tích vào câu đúng)</label>
                                    <div class="input-group mb-2" th:each="i:${#numbers.sequence(0,3)}">
                                        <div class="input-group-text bg-white">
                                            <input class="form-check-input mt-0" type="radio" name="correctIndex" th:value="${i}" required style="cursor: pointer;">
                                        </div>
                                        <input type="text" class="form-control" th:name="|answers[${i}].content|" th:id="|ans_${i}|" placeholder="Nhập đáp án..." required>
                                        <input type="hidden" th:name="|answers[${i}].isCorrect|" value="false" class="is-correct-hidden">
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold text-muted">Giải thích (Optional)</label>
                                    <textarea class="form-control" name="explanation" id="explanation" rows="2"></textarea>
                                </div>

                                <div class="col-12 text-end border-top pt-3">
                                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Đóng</button>
                                    <button type="submit" class="btn btn-primary px-4 fw-bold">Lưu Dữ Liệu</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="import-pane">
                        <form th:action="@{/admin/questions/import}" method="post" enctype="multipart/form-data" class="text-center py-3">
                            <div class="alert alert-info d-inline-block mb-4">
                                <i class="fas fa-info-circle me-1"></i> Vui lòng tải file mẫu để nhập liệu chính xác.
                                <a th:href="@{/admin/questions/download-template}" class="fw-bold ms-2 text-decoration-none"><i class="fas fa-download"></i> Tải Mẫu</a>
                            </div>

                            <div class="row text-start justify-content-center">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label fw-bold">Bước 1: Chọn Môn học (Lọc)</label>
                                    <select class="form-select bg-light" id="importCourseId" onchange="loadQuizzes(this.value, 'importQuizId')">
                                        <option value="">-- Chọn Môn --</option>
                                        <option th:each="c:${courses}" th:value="${c.id}" th:text="${c.name}"></option>
                                    </select>
                                </div>

                                <div class="col-md-8 mb-3">
                                    <label class="form-label fw-bold text-danger">Bước 2: Chọn Quiz (Bắt buộc)</label>
                                    <select class="form-select border-danger" name="quizId" id="importQuizId" required>
                                        <option value="">-- Chọn Môn trước --</option>
                                    </select>
                                    <div class="form-text text-danger small">* Câu hỏi sẽ được thêm trực tiếp vào Quiz này.</div>
                                </div>

                                <div class="col-md-8 mb-4">
                                    <label class="form-label fw-bold">Bước 3: Chọn File (.xlsx)</label>
                                    <input type="file" class="form-control" name="file" accept=".xlsx" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success px-5 py-2 fw-bold shadow-sm">
                                <i class="fas fa-file-import me-2"></i> Tiến hành Import
                            </button>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="ai-pane">
                        <form th:action="@{/admin/questions/generate-ai}" method="post" id="aiForm">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="alert alert-warning border-0 bg-warning-subtle text-dark small">
                                        <i class="fas fa-robot me-2"></i> AI sẽ tự động sinh câu hỏi, đáp án đúng/sai và thêm thẳng vào Quiz bạn chọn.
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold">1. Chọn Môn học</label>
                                    <select class="form-select" name="courseId" id="aiCourseId" onchange="loadQuizzes(this.value, 'aiQuizId')" required>
                                        <option value="">-- Chọn Môn --</option>
                                        <option th:each="c:${courses}" th:value="${c.id}" th:text="${c.name}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-primary">2. Thêm vào Quiz</label>
                                    <select class="form-select border-primary" name="quizId" id="aiQuizId">
                                        <option value="">-- Chọn Môn trước --</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Độ khó</label>
                                    <select class="form-select" name="levelId">
                                        <option th:each="l:${levels}" th:value="${l.id}" th:text="${l.name}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Số lượng câu</label>
                                    <input type="number" class="form-control" name="numQuestions" value="5" min="1" max="10">
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold">Chủ đề / Yêu cầu cho AI</label>
                                    <textarea class="form-control" name="topic" rows="3" placeholder="VD: Hãy tạo câu hỏi về vòng lặp For và While trong Java..." required></textarea>
                                </div>

                                <div class="col-12 text-end border-top pt-3">
                                    <button type="submit" class="btn btn-warning fw-bold px-4 text-dark shadow-sm">
                                        <i class="fas fa-magic me-2"></i> AI Tạo Ngay
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. TOGGLE SIDEBAR
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('expanded');
    }

    // 2. LOGIC CASCADING DROPDOWN (Load Quiz theo Course)
    function loadQuizzes(courseId, targetSelectId) {
        const targetSelect = document.getElementById(targetSelectId);

        // Reset dropdown
        targetSelect.innerHTML = '<option value="">Đang tải dữ liệu...</option>';
        targetSelect.disabled = true;

        if (!courseId) {
            targetSelect.innerHTML = '<option value="">-- Vui lòng chọn Môn trước --</option>';
            targetSelect.disabled = true;
            return;
        }

        // Gọi API
        fetch('/admin/questions/api/quizzes-by-course?courseId=' + courseId)
            .then(response => response.json())
            .then(data => {
                targetSelect.disabled = false;
                if (data.length === 0) {
                    targetSelect.innerHTML = '<option value="">Không có Quiz nào trong môn này</option>';
                } else {
                    targetSelect.innerHTML = '<option value="">-- Chọn Quiz (Hoặc bỏ trống) --</option>';
                    data.forEach(quiz => {
                        const option = document.createElement('option');
                        option.value = quiz.id;
                        option.text = quiz.name;
                        targetSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                targetSelect.innerHTML = '<option value="">Lỗi tải dữ liệu</option>';
            });
    }

    // 3. LOGIC MODAL
    const qModal = new bootstrap.Modal(document.getElementById('questionModal'));

    function openModalAdd() {
        // Reset form
        document.getElementById('manualForm').reset();
        document.getElementById('questionId').value = '';
        document.getElementById('manualQuizId').innerHTML = '<option value="">-- Vui lòng chọn Môn trước --</option>';
        document.getElementById('manualQuizId').disabled = true;
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Thêm Câu Hỏi Mới';

        // Reset Radio buttons
        document.querySelectorAll('input[name="correctIndex"]').forEach(r => r.checked = false);
        document.querySelectorAll('.is-correct-hidden').forEach(i => i.value = 'false');

        qModal.show();
    }

    function editQuestion(id) {
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Sửa Câu Hỏi #' + id;

        // Gọi API lấy chi tiết
        fetch('/admin/questions/api/' + id)
            .then(r => r.json())
            .then(data => {
                // Fill thông tin cơ bản
                document.getElementById('questionId').value = data.id;
                document.getElementById('content').value = data.content;
                document.getElementById('explanation').value = data.explanation;
                document.getElementById('levelId').value = data.levelId;

                // Fill Course
                const courseSelect = document.getElementById('manualCourseId');
                courseSelect.value = data.courseId;

                // Trigger load Quiz và chọn đúng Quiz sau khi load xong
                loadQuizzes(data.courseId, 'manualQuizId');

                // Set timeout để chờ load xong thì mới set value cho Quiz
                setTimeout(() => {
                    if (data.quizId) {
                        document.getElementById('manualQuizId').value = data.quizId;
                    }
                }, 400); // 400ms delay

                // Fill Đáp án
                data.answers.forEach((ans, idx) => {
                    if (idx < 4) {
                        document.getElementById('ans_' + idx).value = ans.content;
                        if (ans.correct) {
                            document.querySelector(`input[name="correctIndex"][value="${idx}"]`).checked = true;
                            // Update hidden input
                            document.querySelector(`input[name="answers[${idx}].isCorrect"]`).value = 'true';
                        } else {
                            document.querySelector(`input[name="answers[${idx}].isCorrect"]`).value = 'false';
                        }
                    }
                });

                qModal.show();
            })
            .catch(err => alert('Lỗi tải dữ liệu: ' + err));
    }

    // 4. LOGIC RADIO BUTTON (Cập nhật hidden input isCorrect)
    document.querySelectorAll('input[name="correctIndex"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Reset tất cả về false
            document.querySelectorAll('.is-correct-hidden').forEach(i => i.value = 'false');
            // Set cái được chọn thành true
            document.querySelector(`input[name="answers[${this.value}].isCorrect"]`).value = 'true';
        });
    });

    // 5. LOADING OVERLAY CHO AI
    const aiForm = document.getElementById('aiForm');
    const loadingOverlay = document.getElementById('loadingOverlay');

    if (aiForm) {
        aiForm.addEventListener('submit', function() {
            qModal.hide(); // Ẩn modal nhập liệu
            loadingOverlay.style.display = 'flex'; // Hiện overlay loading
        });
    }
</script>
</body>
</html>