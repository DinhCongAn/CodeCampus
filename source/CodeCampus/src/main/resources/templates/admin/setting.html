<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Cấu hình hệ thống | Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin-style.css}">
</head>
<body>

<div th:replace="~{fragments/sidebar-menu-admin :: sidebar('settings')}"></div>

<div class="main-content" id="mainContent">

    <!-- Topbar -->
    <div class="topbar d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <div class="toggle-btn me-4" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </div>
            <h4 class="mb-0 fw-bold text-dark">Cấu hình Hệ thống</h4>
        </div>

        <div class="d-flex align-items-center gap-3">

            <!-- Button Quay về trang chủ -->
            <a href="/home" target="_blank"
               class="btn btn-outline-primary btn-sm rounded-pill d-flex align-items-center gap-2 shadow-sm px-3"
               title="Mở trang chủ trong tab mới">
                <i class="fas fa-home"></i>
                <span class="d-none d-md-inline fw-medium">Trang chủ</span>
                <i class="fas fa-external-link-alt small opacity-50 ms-1" style="font-size: 0.75em;"></i>
            </a>

            <!-- Email ẩn để JS dùng -->
            <span id="currentUserEmail" class="d-none" th:text="${email}"></span>

            <!-- Lời chào + Tên -->
            <span class="text-muted small">
            Xin chào, Admin
            <strong th:text="${fullName}">Admin</strong>
        </span>

            <!-- Avatar -->
            <div class="avatar-wrapper">
                <!-- Có avatar trong DB -->
                <img th:if="${avatarUrl}"
                     th:src="${avatarUrl}"
                     width="40"
                     height="40"
                     class="rounded-circle object-fit-cover"
                     alt="Avatar">

                <!-- Không có avatar → fallback theo tên -->
                <img th:unless="${avatarUrl}"
                     th:src="@{'https://ui-avatars.com/api/?name=' + ${fullName} + '&background=4361ee&color=fff'}"
                     width="40"
                     height="40"
                     class="rounded-circle object-fit-cover"
                     alt="Avatar">
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-10">
                        <form th:action="@{/admin/settings}" method="get" class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" name="keyword" class="form-control border-start-0"
                                           placeholder="Tìm theo Key, Giá trị, Mô tả..." th:value="${keyword}">
                                </div>
                            </div>

                            <div class="col-md-3">
                                <select name="type" class="form-select">
                                    <option value="">-- Tất cả loại (Type) --</option>
                                    <option th:each="t : ${typeList}"
                                            th:value="${t}"
                                            th:text="${t}"
                                            th:selected="${t == selectedType}"></option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <select name="status" class="form-select">
                                    <option value="">-- Trạng thái --</option>
                                    <option value="active" th:selected="${selectedStatus == 'active'}">Hoạt động (Active)</option>
                                    <option value="inactive" th:selected="${selectedStatus == 'inactive'}">Vô hiệu (Inactive)</option>
                                </select>
                            </div>

                            <div class="col-md-2 d-flex gap-1">
                                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter"></i></button>
                                <a th:href="@{/admin/settings}" class="btn btn-light border" title="Làm mới"><i class="fas fa-sync"></i></a>
                            </div>
                        </form>
                    </div>

                    <div class="col-lg-2 text-end border-start">
                        <button class="btn btn-success fw-bold w-100" onclick="openModalAdd()">
                            <i class="fas fa-plus me-1"></i> Thêm mới
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-1"></i> <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-1"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="table-card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                    <tr>
                        <th class="ps-4">
                            <a th:href="@{/admin/settings(page=${currentPage}, sortBy='id', sortDir=${reverseSortDir})}" class="text-decoration-none text-dark">
                                ID <i class="fas fa-sort text-muted small ms-1"></i>
                            </a>
                        </th>
                        <th>Mã (Key)</th> <th>Loại (Type)</th>
                        <th>Giá trị (Value)</th>
                        <th>Thứ tự</th>
                        <th>Trạng thái</th>
                        <th class="text-end pe-4">Hành động</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(listSettings)}"><td colspan="7" class="text-center py-5 text-muted">Không tìm thấy cấu hình nào.</td></tr>

                    <tr th:each="item : ${listSettings}">
                        <td class="ps-4 text-muted fw-bold" th:text="${'#' + item.id}">#1</td>

                        <td><span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle font-monospace" th:text="${item.settingKey}">KEY</span></td>

                        <td><span class="badge bg-info-subtle text-info border border-info-subtle" th:text="${item.type}">TYPE</span></td>

                        <td>
                            <div class="d-inline-block text-truncate fw-bold text-primary" style="max-width: 250px;" th:text="${item.settingValue}" th:title="${item.settingValue}">Value</div>
                            <div class="small text-muted text-truncate" style="max-width: 250px;" th:text="${item.description}">Description</div>
                        </td>

                        <td th:text="${item.orderNum}">1</td>

                        <td>
                            <a th:href="@{/admin/settings/toggle/{id}(id=${item.id})}" class="text-decoration-none" title="Nhấn để đổi trạng thái">
                                <span th:if="${item.status == 'active'}" class="badge bg-success-subtle text-success"><i class="fas fa-check-circle me-1"></i> Active</span>
                                <span th:if="${item.status != 'active'}" class="badge bg-secondary-subtle text-secondary"><i class="fas fa-power-off me-1"></i> Inactive</span>
                            </a>
                        </td>

                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-primary me-1"
                                    onclick="openModalEdit(this)"
                                    th:data-id="${item.id}"
                                    th:data-key="${item.settingKey}"
                                    th:data-type="${item.type}"
                                    th:data-value="${item.settingValue}"
                                    th:data-order="${item.orderNum}"
                                    th:data-status="${item.status}"
                                    th:data-desc="${item.description}"
                                    title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>

                            <a th:href="@{/admin/settings/delete/{id}(id=${item.id})}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Bạn có chắc muốn chuyển vào thùng rác?');"
                               title="Xóa">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center p-3 border-top" th:if="${totalPages > 0}">

    <span class="text-muted small">
        Hiển thị <strong th:text="${listSettings.size()}">0</strong>
        trên tổng số <strong th:text="${totalItems}">0</strong> cấu hình
    </span>

                <nav>
                    <ul class="pagination pagination-sm mb-0">

                        <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/settings(page=${currentPage - 1}, keyword=${keyword}, type=${selectedType}, status=${selectedStatus})}">
                                Trước
                            </a>
                        </li>

                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(1, totalPages)}"
                            th:classappend="${i == currentPage ? 'active' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/settings(page=${i}, keyword=${keyword}, type=${selectedType}, status=${selectedStatus})}"
                               th:text="${i}">
                                1
                            </a>
                        </li>

                        <li class="page-item" th:classappend="${currentPage == totalPages ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/settings(page=${currentPage + 1}, keyword=${keyword}, type=${selectedType}, status=${selectedStatus})}">
                                Sau
                            </a>
                        </li>

                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <form th:action="@{/admin/settings/save}" method="post" id="settingForm" class="modal-content border-0 shadow">

        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-bold" id="modalTitle">Thêm Cấu hình Mới</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body p-4">
            <input type="hidden" id="formId" name="id">

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Mã (Key) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control font-monospace" id="formKey" name="settingKey" required placeholder="VD: site_email">
                    <div class="form-text small">Mã duy nhất để dùng trong code.</div>
                </div>

                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Loại (Type) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="formType" name="type" list="typeSuggestions" required placeholder="VD: GENERAL, SYSTEM...">
                    <datalist id="typeSuggestions">
                        <option th:each="t : ${typeList}" th:value="${t}">
                    </datalist>
                </div>

                <div class="col-12">
                    <label class="form-label small fw-bold text-muted">Giá trị (Value) <span class="text-danger">*</span></label>
                    <textarea class="form-control font-monospace" id="formValue" name="settingValue" rows="2" required placeholder="Nhập giá trị cấu hình..."></textarea>
                </div>

                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Thứ tự (Order)</label>
                    <input type="number" class="form-control" id="formOrder" name="orderNum" value="1" min="0">
                </div>

                <div class="col-md-6">
                    <label class="form-label small fw-bold text-muted">Trạng thái</label>
                    <select class="form-select" id="formStatus" name="status">
                        <option value="active">Active (Hoạt động)</option>
                        <option value="inactive">Inactive (Vô hiệu)</option>
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label small fw-bold text-muted">Mô tả (Description)</label>
                    <textarea class="form-control" id="formDesc" name="description" rows="2" placeholder="Mô tả ý nghĩa của cấu hình này..."></textarea>
                </div>
            </div>
        </div>

        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
            <button type="submit" class="btn btn-primary px-4">Lưu dữ liệu</button>
        </div>
    </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Logic Toggle Sidebar
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('expanded');
    }

    // Khởi tạo Modal Bootstrap
    const settingModal = new bootstrap.Modal(document.getElementById('settingModal'));
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('settingForm');

    // Các input fields
    const inpId = document.getElementById('formId');
    const inpKey = document.getElementById('formKey'); // Mới thêm
    const inpType = document.getElementById('formType');
    const inpValue = document.getElementById('formValue');
    const inpOrder = document.getElementById('formOrder');
    const inpDesc = document.getElementById('formDesc');
    const inpStatus = document.getElementById('formStatus');

    // Mở Modal Thêm mới
    function openModalAdd() {
        modalTitle.innerText = "Thêm Cấu hình Mới";
        form.reset();
        inpId.value = "";
        inpStatus.value = "active";

        // Mở khóa ô Key khi thêm mới
        inpKey.readOnly = false;

        settingModal.show();
    }

    // Mở Modal Edit
    function openModalEdit(btn) {
        modalTitle.innerText = "Cập nhật Cấu hình";

        // Lấy data từ attribute của nút bấm
        inpId.value = btn.getAttribute('data-id');
        inpKey.value = btn.getAttribute('data-key'); // Lấy Key
        inpType.value = btn.getAttribute('data-type');
        inpValue.value = btn.getAttribute('data-value'); // Lấy Value
        inpOrder.value = btn.getAttribute('data-order');
        inpDesc.value = btn.getAttribute('data-desc');

        // Map status
        const status = btn.getAttribute('data-status');
        inpStatus.value = (status === 'active') ? 'active' : 'inactive';

        // Khóa ô Key khi Edit để tránh lỗi hệ thống
        inpKey.readOnly = true;

        settingModal.show();
    }
</script>
</body>
</html>