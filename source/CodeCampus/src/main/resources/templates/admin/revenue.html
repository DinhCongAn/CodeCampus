<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Báo cáo Doanh thu | Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin-style.css}">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>

<div th:replace="~{fragments/sidebar-menu-admin :: sidebar('revenue')}"></div>

<div class="main-content" id="mainContent">

    <div class="topbar d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <div class="toggle-btn me-4" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            <h4 class="mb-0 fw-bold text-dark">Báo cáo Doanh thu</h4>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="text-muted small">Xin chào, <strong th:text="${#authentication?.name}">Admin</strong></span>
            <img th:src="@{https://ui-avatars.com/api/?name=Admin&background=4361ee&color=fff}" width="40" class="rounded-circle">
        </div>
    </div>

    <div class="container-fluid py-4">

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body py-3">
                <form th:action="@{/admin/revenue}" method="get" class="row align-items-center g-2">
                    <div class="col-auto"><label class="fw-bold text-muted">Thời gian:</label></div>
                    <div class="col-auto">
                        <input type="date" name="start" class="form-control form-control-sm" th:value="${startDate}">
                    </div>
                    <div class="col-auto"><span>đến</span></div>
                    <div class="col-auto">
                        <input type="date" name="end" class="form-control form-control-sm" th:value="${endDate}">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-primary px-3"><i class="fas fa-search"></i> Xem báo cáo</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 col-xl-4">
                <div class="card border-0 shadow-sm text-white" style="background: linear-gradient(135deg, #2ec4b6, #20a4f3);">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-1 opacity-75 fw-bold">TỔNG DOANH THU (Kỳ này)</p>
                                <h2 class="mb-0 fw-bold" th:text="${#numbers.formatDecimal(totalRevenue, 0, 'POINT', 0, 'COMMA')} + ' ₫'">0 ₫</h2>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-coins fa-3x opacity-50"></i>
                            </div>
                        </div>
                        <div class="mt-3 small">
                            <span th:class="${growth >= 0 ? 'badge bg-white text-success' : 'badge bg-white text-danger'}">
                                <i th:class="${growth >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'}"></i>
                                <span th:text="${#numbers.formatDecimal(growth, 0, 1)} + '%'">0%</span>
                            </span>
                            <span class="opacity-75 ms-1">so với kỳ trước</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-chart-line me-2 text-primary"></i>Biểu đồ Doanh thu theo ngày</h6>
                    </div>
                    <div class="card-body">
                        <div id="revenueChart"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-chart-pie me-2 text-warning"></i>Tỷ trọng theo Danh mục</h6>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div id="categoryPieChart" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-list me-2 text-success"></i>Chi tiết giao dịch thành công</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Mã đơn</th>
                        <th>Khách hàng</th>
                        <th>Khóa học</th>
                        <th>Thời gian</th>
                        <th class="text-end pe-4">Số tiền</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${transactions.empty}"><td colspan="5" class="text-center py-4 text-muted">Không có giao dịch nào.</td></tr>

                    <tr th:each="order : ${transactions.content}">
                        <td class="ps-4 text-primary fw-bold" th:text="${'#' + order.orderCode}">#123</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <img th:src="${order.user.avatarUrl != null ? order.user.avatarUrl : 'https://ui-avatars.com/api/?name=' + order.user.fullName}" class="avatar-sm me-2 rounded-circle" width="30">
                                <span th:text="${order.user.fullName}">Nguyen Van A</span>
                            </div>
                        </td>
                        <td th:text="${order.course.name}">Java Course</td>
                        <td th:text="${#temporals.format(order.registrationTime, 'dd/MM/yyyy HH:mm')}">20/11 10:30</td>
                        <td class="text-end pe-4 fw-bold text-success"
                            th:text="${'+ ' + #numbers.formatDecimal(order.totalCost, 0, 'POINT', 0, 'COMMA') + ' ₫'}">500.000 ₫</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center p-3 border-top"
                 th:if="${transactions != null && transactions.totalPages > 0}"> <span class="text-muted small">
        Hiển thị <strong th:text="${transactions.numberOfElements}">10</strong>
        trên tổng số <strong th:text="${transactions.totalElements}">50</strong> giao dịch
    </span>

                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" th:classappend="${transactions.first ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/revenue(page=${transactions.number - 1}, start=${startDate}, end=${endDate})}">
                                Trước
                            </a>
                        </li>

                        <li class="page-item" th:each="i : ${#numbers.sequence(0, transactions.totalPages - 1)}"
                            th:classappend="${i == transactions.number ? 'active' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/revenue(page=${i}, start=${startDate}, end=${endDate})}"
                               th:text="${i + 1}">1</a>
                        </li>

                        <li class="page-item" th:classappend="${transactions.last ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/revenue(page=${transactions.number + 1}, start=${startDate}, end=${endDate})}">
                                Sau
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

        </div>
    </div>
</div>

<script th:inline="javascript">
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('expanded');
    }

    /*<![CDATA[*/
    const chartLabels = /*[[${chartLabels}]]*/ [];
    const chartData = /*[[${chartData}]]*/ [];

    const catLabels = /*[[${catLabels}]]*/ [];
    const catValues = /*[[${catValues}]]*/ [];

    // 1. Line Chart (Doanh thu ngày)
    new ApexCharts(document.querySelector("#revenueChart"), {
        series: [{ name: "Doanh thu", data: chartData }],
        chart: { type: 'area', height: 350, toolbar: { show: false } },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 3 },
        colors: ['#20a4f3'],
        fill: { type: "gradient", gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] } },
        xaxis: { categories: chartLabels, tooltip: { enabled: false } },
        tooltip: { y: { formatter: val => new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(val) } }
    }).render();

    // 2. Pie Chart (Danh mục)
    if (catValues.length > 0) {
        new ApexCharts(document.querySelector("#categoryPieChart"), {
            series: catValues,
            labels: catLabels,
            chart: { type: 'donut', height: 350 },
            colors: ['#4361ee', '#3f37c9', '#4895ef', '#4cc9f0', '#f72585'],
            legend: { position: 'bottom' },
            tooltip: { y: { formatter: val => new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(val) } }
        }).render();
    } else {
        document.querySelector("#categoryPieChart").innerHTML = "<p class='text-center text-muted mt-5'>Chưa có dữ liệu.</p>";
    }
    /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>