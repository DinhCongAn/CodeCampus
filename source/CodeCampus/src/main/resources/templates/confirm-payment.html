<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác nhận thanh toán</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<h2>Thanh toán khóa học: <span th:text="${registration.course.name}"></span></h2>
<p>Số tiền: <strong th:text="${#numbers.formatDecimal(registration.totalCost,0,'COMMA',0,'POINT')} + ' đ'"></strong></p>

<p>Order Code: <span id="orderCode" th:text="${registration.orderCode}"></span>
    <button onclick="copyOrderCode()">Copy</button></p>

<p>QR Code thanh toán:</p>
<div id="qrcode"></div>
<p><a th:href="${registration.paymentUrl}" target="_blank">Thanh toán nếu không quét QR</a></p>

<p id="status" style="color:red;">Chưa thanh toán</p>

<script>
    // Tạo QR Code
    new QRCode(document.getElementById("qrcode"), {
        text: /*[[${registration.paymentUrl}]]*/ "",
        width: 200,
        height: 200
    });

    // Copy orderCode
    function copyOrderCode() {
        const orderCode = document.getElementById("orderCode").innerText;
        navigator.clipboard.writeText(orderCode).then(() => alert("Copied!"));
    }

    // Auto check status mỗi 3s
    setInterval(() => {
        fetch("/api/registration/status/" + document.getElementById("orderCode").innerText)
            .then(res => res.json())
            .then(data => {
                if (data.status === "COMPLETED") {
                    document.getElementById("status").innerText = "Đã thanh toán ✅";
                    setTimeout(() => {
                        window.location.href = "/courses"; // quay về trang khóa học
                    }, 2000);
                }
            });
    }, 3000);
</script>
</body>
</html>
