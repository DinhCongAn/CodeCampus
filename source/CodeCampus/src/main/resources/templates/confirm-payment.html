<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Xác nhận thanh toán</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class.="bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center">
    <div id="pending-state">
        <h2 class="text-2xl font-bold mb-4">Quét mã để thanh toán</h2>
        <p class="text-gray-600 mb-6">Sử dụng ứng dụng ngân hàng để quét mã QR và hoàn tất đăng ký.</p>

        <img th:src="'data:image/png;base64,' + ${qrCodeBase64}" alt="VietQR" class="w-64 h-64 mx-auto border"/>

        <div class="mt-6 text-left bg-gray-50 p-4 rounded-lg">
            <p><strong>Ngân hàng:</strong> <span th:text="${bankName}"></span></p>
            <p><strong>Chủ tài khoản:</strong> <span th:text="${bankAccountName}"></span></p>
            <p><strong>Số tài khoản:</strong> <span th:text="${bankAccountNo}"></span></p>
            <hr class="my-2">
            <p><strong>Số tiền:</strong> <span class="text-red-600" th:text="${#numbers.formatDecimal(registration.totalCost, 0, 'COMMA', 0, 'POINT') + ' đ'}"></span></p>
            <p><strong>Nội dung:</strong> <span class="text-blue-600" th:text="${registration.orderCode}"></span></p>
            <p class="text-sm text-red-500 mt-2">(*) Vui lòng giữ nguyên nội dung chuyển khoản.</p>
        </div>
    </div>

    <div id="success-state" class="hidden">
        <span class="material-icons text-green-500" style="font-size: 80px;">check_circle</span>
        <h2 class="text-2xl font-bold text-green-600 mt-4">Thanh toán thành công!</h2>
        <p class="text-gray-700 mt-2">Cảm ơn bạn. Email xác nhận đã được gửi đến <strong th:text="${registration.user.email}"></strong>.</p>
        <p class="mt-6">Bạn sẽ được chuyển hướng sau 5 giây...</p>
    </div>
</div>

<script th:inline="javascript">
    /* Lấy ID đơn hàng từ Model (Thymeleaf) */
    const registrationId = /*[[${registration.id}]]*/ 'defaultId';

    function checkPaymentStatus() {
        // Gọi API /api/registration/status/{id}
        fetch(`/api/registration/status/${registrationId}`)
            .then(response => response.json())
            .then(data => {
                // Nếu status là COMPLETED (do Webhook đã cập nhật)
                if (data.status === 'COMPLETED') {
                    // 1. Ẩn QR, Hiện thông báo thành công
                    document.getElementById('pending-state').classList.add('hidden');
                    document.getElementById('success-state').classList.remove('hidden');

                    // 2. Dừng polling
                    clearInterval(pollingInterval);

                    // 3. Chuyển hướng
                    setTimeout(() => {
                        window.location.href = '/my-courses'; // Về trang khóa học của tôi
                    }, 5000);
                }
                // Nếu vẫn là PENDING, không làm gì, chờ lần poll tiếp theo
            });
    }

    // Bắt đầu polling, gọi hàm kiểm tra mỗi 5 giây
    const pollingInterval = setInterval(checkPaymentStatus, 5000);
</script>
</body>
</html>