<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf}"/>

    <title>Lab: [[${lab.name}]] | CodeCampus</title>

    <!-- ================= FONTS & ICONS ================= -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Monaco Editor CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/editor/editor.main.min.css">

    <!-- ================= TAILWIND & CONFIG ================= -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc',
                            400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca',
                            800: '#3730a3', 900: '#312e81',
                        },
                        dark: {
                            bg: '#1e1e1e', // VS Code BG
                            panel: '#252526',
                            border: '#3e3e42',
                            text: '#cccccc'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                color: '#334155',
                                maxWidth: '100%',
                                pre: { backgroundColor: '#1e293b', color: '#e2e8f0', borderRadius: '1rem' },
                            },
                        },
                    }),
                }
            }
        }
    </script>

    <!-- Error Suppression Script for ResizeObserver -->
    <script>
        const resizeObserverLoopErr = 'ResizeObserver loop completed with undelivered notifications';
        window.addEventListener('error', event => {
            if (event.message === resizeObserverLoopErr ||
                (event.message && event.message.indexOf('ResizeObserver loop') >= 0)) {
                event.stopImmediatePropagation();
                return false;
            }
        });
    </script>

    <style>
        /* Background Global */
        body {
            background-color: #f8fafc;
            background-image:
                    radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.08) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.05) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;
        }

        /* Scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Dark Scrollbar */
        .dark-scrollbar::-webkit-scrollbar { width: 10px; height: 10px; }
        .dark-scrollbar::-webkit-scrollbar-track { background: #1e1e1e; }
        .dark-scrollbar::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; border: 2px solid #1e1e1e; }
        .dark-scrollbar::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }

        .font-mono-code { font-family: 'JetBrains Mono', monospace; }
        .chat-link { color: #4f46e5; text-decoration: underline; font-weight: 600; }

        /* Editor Container Styles */
        #ide-overlay {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #ide-overlay.hidden-overlay {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="antialiased font-sans flex flex-col min-h-screen text-slate-800">

<!-- HEADER (Sticky) -->
<div class="sticky top-0 z-50 shrink-0 shadow-sm">
    <div th:replace="~{fragments/header :: header}"></div>
</div>

<div class="flex flex-1 relative items-start">

    <!-- SIDEBAR: LESSON LIST (Sticky) -->
    <aside class="w-full md:w-80 bg-white/80 backdrop-blur-xl border-r border-slate-200/60 flex-shrink-0 hidden md:flex flex-col z-20 sticky top-[74px] h-[calc(100vh-74px)] shadow-xl">
        <!-- Course Header -->
        <div class="p-5 border-b border-slate-100 bg-white/50 backdrop-blur-sm shrink-0">
            <a th:href="@{/my-courses}" class="text-xs font-bold text-slate-500 hover:text-brand-600 flex items-center mb-3 transition-colors uppercase tracking-wider group">
                <i class="fa-solid fa-arrow-left mr-2 transition-transform group-hover:-translate-x-1"></i>
                Quay l·∫°i kh√≥a h·ªçc
            </a>
            <h2 class="text-lg font-extrabold text-slate-900 leading-tight line-clamp-2" th:text="${course.name}">T√™n Kh√≥a h·ªçc</h2>

            <div class="mt-3 w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                <div class="bg-gradient-to-r from-brand-500 to-purple-500 h-full rounded-full" style="width: 45%"></div>
            </div>
        </div>

        <!-- Lessons List -->
        <nav class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-1">
            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-3 mt-2">N·ªôi dung kh√≥a h·ªçc</div>

            <ul class="space-y-1.5 pb-4">
                <li th:each="lesson : ${allLessons}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${lesson.id})}"
                       class="flex items-center p-3 rounded-xl transition-all duration-200 group relative overflow-hidden"
                       th:classappend="${lesson.id == currentLesson.id}
                                ? 'bg-gradient-to-r from-brand-50 to-white text-brand-700 shadow-sm ring-1 ring-brand-200 font-bold'
                                : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium'">

                        <div th:if="${lesson.id == currentLesson.id}" class="absolute left-0 top-0 bottom-0 w-1 bg-brand-500 rounded-l-xl"></div>

                        <span class="mr-3 text-lg flex items-center justify-center w-6 h-6 rounded-full transition-colors"
                              th:classappend="${lesson.id == currentLesson.id} ? 'text-brand-600 bg-brand-100' : 'text-slate-400 bg-slate-100 group-hover:text-slate-600'">
                                <i class="material-icons text-sm" th:switch="${lesson.lessonType?.name}">
                                    <span th:case="'Video'">play_arrow</span>
                                    <span th:case="'Quiz'">quiz</span>
                                    <span th:case="'Lab'">code</span>
                                    <span th:case="*">article</span>
                                </i>
                            </span>

                        <span class="flex-1 text-sm truncate" th:text="${lesson.name}">B√†i h·ªçc</span>
                        <i th:if="${lesson.id == currentLesson.id}" class="fa-solid fa-chart-simple text-brand-500 text-xs animate-pulse ml-2"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- MAIN DASHBOARD CONTENT (View Only) -->
    <div class="flex-1 bg-slate-50/50 flex flex-col min-h-[calc(100vh-74px)]">
        <!-- Expanded Width Container -->
        <div class="max-w-7xl mx-auto w-full p-6 md:p-10 flex-1">

            <!-- Header Card & Stats -->
            <div class="bg-white rounded-[2rem] shadow-xl shadow-brand-900/5 border border-white p-8 md:p-10 mb-8 relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-brand-100/50 to-purple-100/50 rounded-full blur-3xl -mr-16 -mt-16 transition-all group-hover:scale-110"></div>

                <span class="inline-flex items-center gap-2 px-3 py-1 bg-brand-50 text-brand-700 text-xs font-bold uppercase tracking-wider rounded-full mb-4 border border-brand-100">
                    <i class="fa-solid fa-code"></i> Coding Lab
                </span>
                <h1 class="text-3xl md:text-5xl font-black text-slate-900 mb-6 leading-tight" th:text="${lab.name}">T√™n b√†i Lab</h1>
                <p class="text-slate-500 text-lg md:text-xl max-w-3xl leading-relaxed">Ho√†n th√†nh b√†i t·∫≠p th·ª±c h√†nh n√†y ƒë·ªÉ c·ªßng c·ªë ki·∫øn th·ª©c. M√¥i tr∆∞·ªùng IDE chuy√™n nghi·ªáp ƒë√£ s·∫µn s√†ng cho b·∫°n.</p>

                <div class="mt-10">
                    <div class="flex flex-wrap gap-4 items-center mb-5">
                        <button onclick="openIDE()" class="px-8 py-5 bg-slate-900 text-white font-bold rounded-2xl shadow-lg hover:shadow-2xl hover:bg-slate-800 hover:-translate-y-1 transition-all flex items-center gap-3 text-lg group-btn">
                            <span>M·ªü Tr√¨nh bi√™n t·∫≠p Code</span>
                            <i class="fa-solid fa-arrow-right-long transition-transform group-btn-hover:translate-x-1"></i>
                        </button>

                        <!-- Score Box -->
                        <div th:if="${attempt.aiGrade != null}" class="px-6 py-5 bg-white border border-slate-200 rounded-2xl flex items-center gap-3 shadow-sm">
                            <div class="text-xs font-bold text-slate-400 uppercase">K·∫øt qu·∫£ g·∫ßn nh·∫•t:</div>
                            <div class="font-black text-xl" th:classappend="${attempt.aiGrade >= 70 ? 'text-emerald-600' : 'text-red-600'}" th:text="${attempt.aiGrade} + '/100'"></div>
                        </div>
                    </div>

                    <!-- AI Feedback Box (Ngay d∆∞·ªõi ƒëi·ªÉm s·ªë) -->
                    <div th:if="${attempt.aiGrade != null and attempt.aiFeedback != null}" class="bg-white/60 backdrop-blur-md border border-slate-200/60 p-5 rounded-2xl max-w-4xl text-slate-700 leading-relaxed shadow-sm relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1" th:classappend="${attempt.aiGrade >= 70 ? 'bg-emerald-400' : 'bg-red-400'}"></div>
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-wand-magic-sparkles mt-1" th:classappend="${attempt.aiGrade >= 70 ? 'text-emerald-500' : 'text-red-500'}"></i>
                            <div>
                                <span class="font-bold text-slate-900 block mb-1">Nh·∫≠n x√©t c·ªßa AI:</span>
                                <span th:text="${attempt.aiFeedback}"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description Preview (Full Width - Removed Lab Info Box) -->
            <div class="mb-16">
                <h3 class="font-bold text-xl text-slate-900 mb-4 flex items-center gap-2"><i class="fa-solid fa-book-open text-brand-500"></i> M√¥ t·∫£ b√†i t·∫≠p</h3>
                <div th:utext="${lab.description}" class="prose prose-lg prose-slate max-w-none bg-white p-8 rounded-2xl border border-slate-200 shadow-sm"></div>
            </div>

            <!-- Navigation Buttons (Prev/Next) -->
            <div class="flex justify-between items-center pt-8 border-t border-slate-200 mt-12">
                <!-- Prev Button -->
                <div th:if="${prevLesson != null}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${prevLesson.id})}"
                       class="group flex items-center gap-4 px-5 py-3 bg-white border border-slate-200 rounded-2xl shadow-sm hover:border-brand-200 hover:shadow-md transition-all">
                        <div class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center group-hover:bg-brand-50 group-hover:text-brand-600 transition-colors">
                            <i class="fa-solid fa-chevron-left"></i>
                        </div>
                        <div class="text-left hidden sm:block">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">B√†i tr∆∞·ªõc</div>
                            <div class="text-sm font-bold text-slate-700 group-hover:text-brand-700 max-w-[150px] truncate" th:text="${prevLesson.name}">Name</div>
                        </div>
                    </a>
                </div>
                <div th:if="${prevLesson == null}"></div>

                <!-- Next Button -->
                <div th:if="${nextLesson != null}">
                    <a th:href="@{/learning/{courseId}/{lessonId}(courseId=${course.id}, lessonId=${nextLesson.id})}"
                       class="group flex items-center gap-4 px-5 py-3 bg-white border border-slate-200 rounded-2xl shadow-sm hover:border-brand-200 hover:shadow-md transition-all">
                        <div class="text-right hidden sm:block">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">B√†i ti·∫øp theo</div>
                            <div class="text-sm font-bold text-slate-700 group-hover:text-brand-700 max-w-[150px] truncate" th:text="${nextLesson.name}">Name</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center group-hover:bg-brand-600 group-hover:text-white transition-colors">
                            <i class="fa-solid fa-chevron-right"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FOOTER (Full Page - Covers sidebar and content) -->
<div class="border-t border-slate-200 bg-white relative z-30">
    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<!-- ================= IDE OVERLAY (POPUP) ================= -->
<div id="ide-overlay" class="fixed inset-0 z-[100] bg-[#1e1e1e] flex flex-col hidden-overlay">
    <input type="hidden" id="attemptId" th:value="${attempt.id}" />

    <!-- IDE Header -->
    <div class="h-14 bg-[#252526] border-b border-[#3e3e42] flex items-center justify-between px-4 shrink-0 shadow-lg relative z-20">
        <div class="flex items-center gap-4">
            <button onclick="closeIDE()" class="w-8 h-8 rounded-lg bg-[#3e3e42] hover:bg-[#505050] text-slate-300 flex items-center justify-center transition-colors">
                <i class="fa-solid fa-chevron-down"></i>
            </button>
            <div class="h-6 w-px bg-[#3e3e42]"></div>
            <h2 class="text-slate-200 font-bold text-sm truncate max-w-xs" th:text="${lab.name}">Lab Name</h2>
        </div>

        <div class="flex items-center gap-3">
            <div id="saveStatus" class="text-xs text-slate-500 italic hidden md:block">ƒê√£ l∆∞u t·ª± ƒë·ªông</div>
            <button onclick="clearCode()" class="text-xs font-bold text-slate-400 hover:text-red-400 px-3 py-1.5 rounded hover:bg-[#3e3e42] transition-colors flex items-center gap-2">
                <i class="fa-solid fa-trash-can"></i> X√≥a Code
            </button>
        </div>
    </div>

    <!-- IDE Body (Split View) -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Left Panel: Instructions (35%) - KEEP LIGHT THEME -->
        <div class="w-[35%] bg-white border-r border-slate-200 flex flex-col text-slate-700 hidden md:flex shadow-[4px_0_24px_rgba(0,0,0,0.1)] z-10">
            <div class="p-3 bg-slate-50 border-b border-slate-200 text-xs font-bold uppercase tracking-wider text-slate-500 flex justify-between items-center">
                <span><i class="fa-solid fa-book-open mr-2 text-brand-600"></i>ƒê·ªÅ b√†i & H∆∞·ªõng d·∫´n</span>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-white">
                <!-- Description with Light Theme -->
                <div class="prose prose-sm prose-slate max-w-none" th:utext="${lab.description}"></div>

                <!-- Grading Result inside Popup -->
                <div id="gradingResult" class="mt-8 p-5 rounded-xl border border-slate-200 bg-slate-50 hidden">
                    <h4 class="text-sm font-bold mb-3 flex items-center gap-2 text-slate-800">
                        <i class="fa-solid fa-medal text-yellow-500"></i> K·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm
                    </h4>
                    <div class="flex items-baseline gap-2 mb-3">
                        <span id="aiScore" class="text-4xl font-black text-slate-900">0</span>
                        <span class="text-sm font-bold text-slate-400">/ 100</span>
                    </div>
                    <div class="p-3 bg-white rounded-lg border border-slate-200 text-xs font-medium text-slate-600 leading-relaxed" id="aiFeedback"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Editor + Terminal (65%) - KEEP DARK THEME -->
        <div class="flex-1 flex flex-col min-w-0 bg-[#1e1e1e]">
            <!-- Tabs -->
            <div class="h-9 flex bg-[#252526] border-b border-[#3e3e42]">
                <div class="px-4 flex items-center gap-2 bg-[#1e1e1e] border-t-2 border-brand-500 text-xs font-medium text-slate-200">
                    <i class="fa-brands fa-java text-orange-400"></i> Solution.java
                </div>
            </div>

            <!-- Monaco Editor -->
            <div class="flex-1 relative overflow-hidden">
                <div id="editor" class="absolute inset-0"></div>
            </div>

            <!-- Terminal -->
            <div class="h-48 border-t border-[#3e3e42] bg-[#1e1e1e] flex flex-col shrink-0">
                <div class="h-8 px-4 flex items-center justify-between bg-[#252526] border-b border-[#3e3e42]">
                    <span class="text-xs font-bold text-slate-400 uppercase">Terminal</span>
                    <button onclick="clearConsole()" class="text-[10px] text-slate-500 hover:text-white"><i class="fa-solid fa-ban"></i> Clear</button>
                </div>
                <div id="console-output" class="flex-1 p-3 font-mono-code text-xs text-slate-300 overflow-y-auto dark-scrollbar whitespace-pre-wrap">
                    <span class="text-[#555]">Ready to execute...</span>
                </div>
            </div>

            <!-- Actions Toolbar -->
            <div class="h-16 bg-[#252526] border-t border-[#3e3e42] flex items-center justify-end px-6 gap-3 shrink-0">
                <button id="runCodeBtn" class="px-5 py-2.5 rounded-lg bg-[#3e3e42] hover:bg-[#4e4e4e] text-slate-200 text-sm font-bold transition-all flex items-center gap-2 border border-[#555]">
                    <i class="fa-solid fa-play text-emerald-500"></i> Ch·∫°y th·ª≠
                </button>
                <button id="submitLabBtn" class="px-6 py-2.5 rounded-lg bg-brand-600 hover:bg-brand-500 text-white text-sm font-bold shadow-lg shadow-brand-900/40 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> N·ªôp b√†i
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= AI CHAT WIDGET ================= -->
<div class="fixed bottom-6 right-6 z-[110] flex flex-col items-end pointer-events-none">
    <div id="ai-chat-window" class="pointer-events-auto bg-white/90 backdrop-blur-xl w-[380px] h-[550px] rounded-[1.5rem] shadow-2xl border border-white/50 mb-4 transform transition-all duration-300 translate-y-10 opacity-0 invisible flex flex-col overflow-hidden ring-1 ring-slate-900/5 font-sans origin-bottom-right">
        <div class="bg-gradient-to-r from-brand-600 to-indigo-600 px-5 py-4 flex items-center justify-between cursor-pointer shadow-md" id="header-chat">
            <div class="flex items-center space-x-3">
                <div class="w-9 h-9 rounded-full bg-white/20 flex items-center justify-center text-lg backdrop-blur-sm border border-white/20 shadow-inner">ü§ñ</div>
                <div>
                    <h4 class="font-bold text-sm text-white">Tr·ª£ l√Ω Lab AI</h4>
                    <div class="flex items-center space-x-1.5">
                        <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse shadow-[0_0_5px_rgba(52,211,153,0.8)]"></span>
                        <span class="text-[10px] text-white/90 font-medium">ƒêang tr·ª±c tuy·∫øn</span>
                    </div>
                </div>
            </div>
            <button id="closeChatBtn" class="text-white/70 hover:text-white hover:bg-white/10 p-1.5 rounded-lg transition-colors"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="chatHistory" class="flex-1 bg-slate-50/50 p-4 overflow-y-auto custom-scrollbar space-y-4 scroll-smooth">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs shrink-0 text-slate-700 shadow-sm">ü§ñ</div>
                <div class="flex flex-col space-y-1 max-w-[85%]">
                    <div class="bg-white text-slate-700 px-4 py-3 rounded-2xl rounded-tl-none text-sm shadow-sm border border-slate-100 font-medium">
                        Ch√†o b·∫°n! üëã M√¨nh l√† AI h·ªó tr·ª£ b√†i lab n√†y.<br>N·∫øu code g·∫∑p l·ªói ho·∫∑c c·∫ßn g·ª£i √Ω, c·ª© h·ªèi m√¨nh nh√©!
                    </div>
                </div>
            </div>
        </div>
        <div class="p-3 bg-white border-t border-slate-100 shrink-0">
            <div class="relative flex items-center gap-2">
                <input type="text" id="chatInput" placeholder="H·ªèi v·ªÅ l·ªói code..."
                       class="w-full bg-slate-100 text-slate-800 text-sm rounded-xl py-3 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:bg-white transition-all placeholder-slate-400 font-medium">
                <button id="chatSendBtn" class="p-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg disabled:opacity-50"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>
    <button id="aiFloatButton" class="pointer-events-auto group relative flex items-center justify-center w-14 h-14 bg-gradient-to-br from-brand-600 to-indigo-600 text-white rounded-full shadow-lg hover:shadow-brand-500/50 transition-all duration-300 animate-float hover:scale-110 border-2 border-white z-50">
        <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
    </button>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
<script th:inline="javascript">
    // === 1. Layout & Modal Logic ===
    const overlay = document.getElementById('ide-overlay');
    let isEditorInitialized = false;
    let editor;
    const initialCode = /*[[${initialCode}]]*/ '// Code here';

    function openIDE() {
        overlay.classList.remove('hidden-overlay');
        document.body.style.overflow = 'hidden'; // Kh√≥a scroll trang ch√≠nh

        // Init editor l·∫ßn ƒë·∫ßu m·ªü n·∫øu ch∆∞a c√≥
        if (!isEditorInitialized) {
            initMonaco();
            isEditorInitialized = true;
        } else {
            // Fix layout bug khi hidden -> show
            setTimeout(() => editor.layout(), 100);
        }
    }

    function closeIDE() {
        overlay.classList.add('hidden-overlay');
        document.body.style.overflow = ''; // M·ªü scroll
    }

    function clearCode() {
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô code hi·ªán t·∫°i v√† quay v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu?")) {
            editor.setValue(initialCode);
        }
    }

    function clearConsole() {
        document.getElementById('console-output').innerHTML = '<span class="text-[#555]">Ready to execute...</span>';
    }

    // === 2. Monaco Init ===
    function initMonaco() {
        const labType = /*[[${lab.labType}]]*/ 'javascript';
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' }});
        require(['vs/editor/editor.main'], () => {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: initialCode,
                language: labType,
                theme: 'vs-dark',
                fontSize: 14,
                lineHeight: 24,
                minimap: { enabled: true },
                padding: { top: 20, bottom: 20 },
                scrollBeyondLastLine: false,
                fontFamily: 'JetBrains Mono',
                automaticLayout: true
            });

            // Auto save sim
            editor.onDidChangeModelContent(() => {
                const status = document.getElementById('saveStatus');
                status.innerText = "ƒêang l∆∞u...";
                clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(() => {
                    status.innerText = "ƒê√£ l∆∞u t·ª± ƒë·ªông";
                }, 1000);
            });
        });
    }

    // === 3. Chat Utils ===
    function formatMessageContent(text) {
        if(!text) return '';
        let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        safeText = safeText.replace(urlRegex, url => `<a href="${url}" target="_blank" class="chat-link">${url}</a>`);
        return safeText.replace(/\n/g, '<br>');
    }

    // === 4. Run & Submit Logic ===
    document.addEventListener('DOMContentLoaded', function() {
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
        if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

        const attemptId = document.getElementById('attemptId').value;
        const runBtn = document.getElementById('runCodeBtn');
        const submitBtn = document.getElementById('submitLabBtn');
        const consoleOut = document.getElementById('console-output');

        // Run Code
        runBtn.onclick = async function() {
            const code = editor.getValue();
            runBtn.disabled = true;
            runBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-emerald-500"></i> Running...';
            consoleOut.innerHTML = '<span class="text-yellow-400">Compiling and running...</span>';

            // Fake API Call (Thay b·∫±ng API th·∫≠t c·ªßa b·∫°n)
            try {
                await new Promise(r => setTimeout(r, 1500));
                const mockResponse = { success: true, output: "Hello World!\nProgram finished with exit code 0" };
                if(mockResponse.success) {
                    consoleOut.innerHTML = `<span class="text-green-400">${mockResponse.output.replace(/\n/g, '<br>')}</span>`;
                }
            } catch (e) {
                consoleOut.innerHTML = '<span class="text-red-500">Error executing code.</span>';
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="fa-solid fa-play text-emerald-500"></i> Ch·∫°y th·ª≠';
            }
        };

        // Submit Code
        submitBtn.onclick = function() {
            if (!confirm('N·ªôp b√†i ƒë·ªÉ ch·∫•m ƒëi·ªÉm?')) return;
            const code = editor.getValue();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang ch·∫•m...';

            // Logic c≈© gi·ªØ nguy√™n
            const fd = new URLSearchParams();
            fd.append('attemptId', attemptId);
            fd.append('code', code);

            // Mockup process status
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> N·ªôp b√†i';
                document.getElementById('gradingResult').classList.remove('hidden');
                document.getElementById('aiScore').innerText = '85';
                document.getElementById('aiFeedback').innerText = 'Code t·ªët, logic ƒë√∫ng. C·∫ßn t·ªëi ∆∞u th√™m v√≤ng l·∫∑p.';

                // Color logic
                document.getElementById('aiScore').classList.add('text-emerald-600');

                alert("ƒê√£ ch·∫•m ƒëi·ªÉm xong!");
            }, 2000);
        };
    });

    // === 5. Chat UI Logic ===
    const aiBtn = document.getElementById('aiFloatButton');
    const chatWindow = document.getElementById('ai-chat-window');
    const closeChatBtn = document.getElementById('closeChatBtn');
    const headerChat = document.getElementById('header-chat');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatHistory = document.getElementById('chatHistory');

    function toggleChat() {
        if (chatWindow.classList.contains('invisible')) {
            chatWindow.classList.remove('invisible', 'opacity-0', 'translate-y-10');
            aiBtn.classList.add('opacity-0', 'scale-0');
            setTimeout(() => chatInput.focus(), 300);
        } else {
            chatWindow.classList.add('opacity-0', 'translate-y-10');
            aiBtn.classList.remove('opacity-0', 'scale-0');
            setTimeout(() => chatWindow.classList.add('invisible'), 300);
        }
    }

    aiBtn.onclick = toggleChat;
    closeChatBtn.onclick = toggleChat;
    headerChat.onclick = (e) => { if(!e.target.closest('button')) toggleChat() };

    const sendChat = () => {
        const msg = chatInput.value.trim();
        if (!msg) return;
        const div = document.createElement('div');
        div.className = `flex items-start gap-3 flex-row-reverse message-enter`;
        div.innerHTML = `<div class="bg-brand-600 text-white rounded-2xl rounded-tr-none shadow-md px-4 py-2.5 text-sm">${formatMessageContent(msg)}</div>`;
        chatHistory.appendChild(div);
        chatInput.value = '';
        chatHistory.scrollTop = chatHistory.scrollHeight;
    };
    chatSendBtn.onclick = sendChat;
    chatInput.addEventListener('keydown', e => e.key === 'Enter' && sendChat());
</script>
</body>
</html>