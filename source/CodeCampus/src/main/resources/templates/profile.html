<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân - CodeCampus</title>

    <!-- ================= FONTS & ICONS (ĐỒNG BỘ) ================= -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- ================= LIBS: CROPPER & AOS ================= -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- ================= TAILWIND & CONFIG ================= -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
                        'glow': '0 0 40px -10px rgba(99, 102, 241, 0.5)',
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- GLOBAL BACKGROUND --- */
        body {
            background-color: #f8fafc;
            background-image:
                    radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.12) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.08) 0px, transparent 50%),
                    radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.1) 0px, transparent 50%),
                    radial-gradient(at 0% 100%, rgba(168, 85, 247, 0.08) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;
            color: #1e293b;
        }

        /* --- GLASS CLASSES --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }

        .cropper-container { width: 100%; height: 100%; }

        /* Validation Icons */
        .valid-icon { display: none; }
        .invalid-icon { display: inline; }
        .rule-valid .valid-icon { display: inline; }
        .rule-valid .invalid-icon { display: none; }
        .rule-valid { color: #16a34a; font-weight: 600; }
    </style>
</head>

<body class="antialiased font-sans selection:bg-brand-500 selection:text-white min-h-screen flex flex-col">

<!-- Header Sticky -->
<div class="sticky top-0 z-50">
    <div th:replace="~{fragments/header :: header}"></div>
</div>

<div class="relative w-full max-w-[1400px] mx-auto py-10 px-4 sm:px-6 lg:px-8 flex-grow">

    <!-- ================= DECOR BACKGROUND ================= -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="absolute top-20 left-10 w-[600px] h-[600px] bg-brand-400/15 rounded-full blur-[120px] mix-blend-multiply animate-blob"></div>
        <div class="absolute bottom-20 right-10 w-[600px] h-[600px] bg-purple-300/15 rounded-full blur-[120px] mix-blend-multiply animate-blob animation-delay-2000"></div>
    </div>

    <!-- Mobile Header -->
    <div class="mb-8 md:hidden" data-aos="fade-down">
        <h1 class="text-3xl font-extrabold text-slate-900">Cài đặt tài khoản</h1>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">

        <!-- ================= SIDEBAR (Left) ================= -->
        <aside class="w-full lg:w-80 shrink-0" data-aos="fade-right">
            <div class="sticky top-28 space-y-6">

                <!-- 1. AVATAR CARD -->
                <div class="glass-card rounded-[2rem] p-8 flex flex-col items-center text-center relative overflow-hidden group">
                    <!-- Background Glow -->
                    <div class="absolute top-0 inset-x-0 h-32 bg-gradient-to-b from-brand-50 to-transparent opacity-50"></div>

                    <form id="avatarForm" th:action="@{/profile/avatar-upload}" method="post" enctype="multipart/form-data" class="flex flex-col items-center relative z-10">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="relative mb-4">
                            <!-- Avatar Circle -->
                            <div class="w-36 h-36 rounded-full p-1 bg-gradient-to-tr from-brand-300 to-purple-300 shadow-glow cursor-pointer group/avatar relative" onclick="openViewModal()">
                                <div class="w-full h-full rounded-full overflow-hidden border-4 border-white bg-white relative">
                                    <img id="avatarPreview" th:if="${user.avatarUrl}" th:src="@{${user.avatarUrl}}" class="w-full h-full object-cover transition-transform duration-500 group-hover/avatar:scale-110">
                                    <img id="avatarPreview" th:unless="${user.avatarUrl}" src="https://ui-avatars.com/api/?name=User&background=random" class="w-full h-full object-cover">

                                    <!-- View Icon Overlay -->
                                    <div class="absolute inset-0 bg-black/30 opacity-0 group-hover/avatar:opacity-100 flex items-center justify-center transition-opacity">
                                        <i class="fa-solid fa-eye text-white text-xl drop-shadow-md"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Button (Floating) -->
                            <label class="absolute bottom-2 right-2 w-10 h-10 bg-brand-600 hover:bg-brand-700 text-white rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:shadow-brand-500/50 hover:-translate-y-1 transition-all duration-300 border-2 border-white z-20">
                                <i class="fa-solid fa-camera"></i>
                                <input type="file" id="avatarInput" name="avatarFile" accept="image/*" class="hidden" onchange="initCropper(this)">
                            </label>
                        </div>

                        <!-- Action Buttons (Hidden by default) -->
                        <div id="avatarActions" class="hidden space-x-2 animate-fade-in mb-3">
                            <button type="button" onclick="cancelAvatar()" class="text-xs px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100 text-slate-600 font-bold transition">
                                Hủy
                            </button>
                            <button type="submit" class="text-xs px-3 py-1.5 rounded-lg bg-brand-600 hover:bg-brand-700 text-white font-bold shadow-md transition">
                                Lưu
                            </button>
                        </div>
                    </form>

                    <div>
                        <h2 class="text-xl font-extrabold text-slate-900" th:text="${user.fullName}">User Name</h2>
                        <p class="text-sm text-slate-500 font-medium truncate max-w-[200px]" th:text="${user.email}">user@example.com</p>
                    </div>
                </div>

                <!-- 2. NAVIGATION MENU -->
                <nav class="glass-card rounded-[1.5rem] p-3 space-y-1">
                    <button onclick="switchTab('general')" id="btn-general"
                            class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl text-left transition-all duration-200 group">
                        <span class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors bg-brand-100 text-brand-600 group-[.active]:bg-brand-600 group-[.active]:text-white">
                            <i class="fa-regular fa-id-card"></i>
                        </span>
                        <span class="font-bold text-sm text-slate-600 group-[.active]:text-brand-700">Thông tin chung</span>
                    </button>

                    <button onclick="switchTab('security')" id="btn-security"
                            class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl text-left transition-all duration-200 group">
                        <span class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors bg-slate-100 text-slate-500 group-hover:bg-brand-50 group-hover:text-brand-500 group-[.active]:bg-brand-600 group-[.active]:text-white">
                            <i class="fa-solid fa-shield-halved"></i>
                        </span>
                        <span class="font-bold text-sm text-slate-600 group-hover:text-slate-900 group-[.active]:text-brand-700">Bảo mật</span>
                    </button>

                    <button onclick="switchTab('notifications')" id="btn-notifications"
                            class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl text-left transition-all duration-200 group">
                        <span class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors bg-slate-100 text-slate-500 group-hover:bg-brand-50 group-hover:text-brand-500 group-[.active]:bg-brand-600 group-[.active]:text-white">
                            <i class="fa-regular fa-bell"></i>
                        </span>
                        <span class="font-bold text-sm text-slate-600 group-hover:text-slate-900 group-[.active]:text-brand-700">Thông báo</span>
                    </button>
                </nav>
            </div>
        </aside>

        <!-- ================= MAIN CONTENT (Right) ================= -->
        <div class="flex-grow space-y-6" data-aos="fade-up" data-aos-delay="100">

            <!-- ALERTS -->
            <div th:if="${profileSuccess}" class="glass-card bg-emerald-50/80 border-l-4 border-emerald-500 text-emerald-700 p-4 rounded-xl flex items-center gap-3 animate-fade-in shadow-sm">
                <i class="fa-solid fa-circle-check text-xl"></i>
                <span class="font-medium" th:text="${profileSuccess}"></span>
            </div>
            <div th:if="${profileError}" class="glass-card bg-red-50/80 border-l-4 border-red-500 text-red-700 p-4 rounded-xl flex items-center gap-3 animate-fade-in shadow-sm">
                <i class="fa-solid fa-circle-exclamation text-xl"></i>
                <span class="font-medium" th:text="${profileError}"></span>
            </div>

            <!-- TAB 1: GENERAL INFO -->
            <section id="tab-general" class="tab-content glass-card bg-white/80 rounded-[2rem] p-8 md:p-10">
                <div class="flex items-center justify-between mb-8 pb-4 border-b border-slate-200/60">
                    <h3 class="text-xl font-extrabold text-slate-900">Thông tin cá nhân</h3>
                    <span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-bold uppercase tracking-wider">Public Profile</span>
                </div>

                <form th:action="@{/profile/update}" th:object="${user}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" th:field="*{email}">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <!-- Full Name -->
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Họ và tên</label>
                            <input type="text" th:field="*{fullName}" class="w-full rounded-xl border-slate-200 bg-white/50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all shadow-sm outline-none">
                            <p class="text-red-500 text-xs mt-1 font-medium" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></p>
                        </div>

                        <!-- Gender -->
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Giới tính</label>
                            <div class="relative">
                                <select th:field="*{gender}" class="w-full rounded-xl border-slate-200 bg-white/50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all shadow-sm outline-none appearance-none">
                                    <option value="">-- Chọn --</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                    <option value="Khác">Khác</option>
                                </select>
                                <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Email (Readonly) -->
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Email</label>
                            <div class="relative">
                                <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" th:value="*{email}" readonly class="w-full rounded-xl border-slate-200 bg-slate-100 pl-10 pr-4 py-3 text-sm text-slate-500 cursor-not-allowed shadow-inner">
                            </div>
                        </div>

                        <!-- Phone -->
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Số điện thoại</label>
                            <div class="relative">
                                <i class="fa-solid fa-phone absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" th:field="*{mobile}" class="w-full rounded-xl border-slate-200 bg-white/50 pl-10 pr-4 py-3 text-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all shadow-sm outline-none">
                            </div>
                            <p class="text-red-500 text-xs mt-1 font-medium" th:if="${#fields.hasErrors('mobile')}" th:errors="*{mobile}"></p>
                        </div>

                        <!-- Address Section -->
                        <div class="col-span-2 pt-6 border-t border-slate-100 mt-2">
                            <h4 class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2"><i class="fa-solid fa-map-location-dot text-brand-500"></i> Địa chỉ giao hàng</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <select id="province" class="rounded-xl border-slate-200 bg-white/50 text-sm py-3 px-3 shadow-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none"></select>
                                <select id="district" class="rounded-xl border-slate-200 bg-white/50 text-sm py-3 px-3 shadow-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none"></select>
                                <select id="ward" class="rounded-xl border-slate-200 bg-white/50 text-sm py-3 px-3 shadow-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none"></select>
                            </div>
                            <input id="addressDetail" placeholder="Số nhà, tên đường..." class="w-full rounded-xl border-slate-200 bg-white/50 text-sm py-3 px-4 shadow-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none">
                            <input type="hidden" th:field="*{address}" id="finalAddress">
                        </div>
                    </div>

                    <div class="mt-10 flex justify-end">
                        <button type="submit" class="bg-gradient-to-r from-brand-600 to-indigo-600 text-white hover:from-brand-500 hover:to-indigo-500 px-8 py-3 rounded-xl shadow-lg hover:shadow-brand-500/30 font-bold transition-all transform hover:-translate-y-0.5">
                            Lưu thay đổi
                        </button>
                    </div>
                </form>
            </section>

            <!-- TAB 2: SECURITY -->
            <section id="tab-security" class="tab-content glass-card bg-white/80 rounded-[2rem] p-8 md:p-10 hidden">
                <div class="flex items-center justify-between mb-8 pb-4 border-b border-slate-200/60">
                    <h3 class="text-xl font-extrabold text-slate-900">Đổi mật khẩu</h3>
                    <i class="fa-solid fa-lock text-brand-500 text-xl"></i>
                </div>

                <div th:if="${isGoogleAccount}" class="mb-8 p-5 bg-blue-50/80 border border-blue-200 text-blue-800 rounded-2xl flex gap-4 text-sm items-start shadow-sm">
                    <i class="fa-brands fa-google text-xl mt-0.5"></i>
                    <div>
                        <strong>Bạn đang đăng nhập bằng Google.</strong><br>
                        Hãy tạo mật khẩu mới để có thể đăng nhập bằng Email và Mật khẩu ở những lần sau.
                    </div>
                </div>

                <form id="passwordForm" th:action="@{/profile/change-password}" th:object="${passwordDto}" method="post" class="max-w-2xl">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="space-y-6">
                        <div th:unless="${isGoogleAccount}">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Mật khẩu hiện tại</label>
                            <div class="relative">
                                <input type="password" id="oldPass" th:field="*{oldPassword}" class="w-full md:w-3/4 rounded-xl border-slate-200 bg-white/50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all shadow-sm outline-none">
                                <button type="button" onclick="togglePassword('oldPass', this)" class="absolute inset-y-0 right-0 md:right-1/4 pr-4 flex items-center text-slate-400 hover:text-brand-600 transition-colors">
                                    <i class="fa-regular fa-eye"></i>
                                </button>
                            </div>
                            <p class="text-red-500 text-xs mt-1 font-medium" th:if="${#fields.hasErrors('oldPassword')}" th:errors="*{oldPassword}"></p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Mật khẩu mới</label>
                                <div class="relative">
                                    <input type="password" id="newPass" th:field="*{newPassword}" class="w-full rounded-xl border-slate-200 bg-white/50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all shadow-sm outline-none">
                                    <button type="button" onclick="togglePassword('newPass', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-brand-600 transition-colors">
                                        <i class="fa-regular fa-eye"></i>
                                    </button>
                                </div>
                                <p class="text-red-500 text-xs mt-1 font-medium" th:if="${#fields.hasErrors('newPassword')}" th:errors="*{newPassword}"></p>

                                <ul class="mt-3 text-xs text-slate-500 space-y-1.5 font-medium bg-slate-50 p-3 rounded-lg border border-slate-100" id="passwordChecklist">
                                    <li id="rule-length" class="flex items-center gap-2"><i class="fa-solid fa-circle text-[6px] invalid-icon text-slate-300"></i><i class="fa-solid fa-check valid-icon"></i> Tối thiểu 8 ký tự</li>
                                    <li id="rule-case" class="flex items-center gap-2"><i class="fa-solid fa-circle text-[6px] invalid-icon text-slate-300"></i><i class="fa-solid fa-check valid-icon"></i> Chữ hoa & chữ thường</li>
                                    <li id="rule-number" class="flex items-center gap-2"><i class="fa-solid fa-circle text-[6px] invalid-icon text-slate-300"></i><i class="fa-solid fa-check valid-icon"></i> Số hoặc ký tự đặc biệt</li>
                                </ul>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Xác nhận lại</label>
                                <div class="relative">
                                    <input type="password" id="confirmPass" th:field="*{confirmPassword}" class="w-full rounded-xl border-slate-200 bg-white/50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 transition-all shadow-sm outline-none">
                                    <button type="button" onclick="togglePassword('confirmPass', this)" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-brand-600 transition-colors">
                                        <i class="fa-regular fa-eye"></i>
                                    </button>
                                </div>
                                <p class="text-red-500 text-xs mt-1 font-medium" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></p>
                                <p id="passwordMatchMsg" class="text-xs mt-2 h-4 font-bold transition-all duration-200"></p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-10">
                        <button id="btnSubmitPassword" type="submit" class="bg-gradient-to-r from-brand-600 to-indigo-600 text-white hover:from-brand-500 hover:to-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed px-8 py-3 rounded-xl shadow-lg font-bold transition-all transform hover:-translate-y-0.5">
                            <span th:text="${isGoogleAccount} ? 'Tạo mật khẩu' : 'Đổi mật khẩu'"></span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- TAB 3: NOTIFICATIONS -->
            <section id="tab-notifications" class="tab-content glass-card bg-white/80 rounded-[2rem] p-8 md:p-10 hidden">
                <div class="border-b border-slate-200/60 pb-6 mb-6"><h3 class="text-xl font-extrabold text-slate-900">Cài đặt thông báo</h3></div>

                <div class="space-y-8">
                    <div class="flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex gap-4 items-center">
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i class="fa-solid fa-envelope"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-900 text-sm">Email thông báo</h4>
                                <p class="text-xs text-slate-500">Nhận cập nhật về khóa học, bảo mật.</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex gap-4 items-center">
                            <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600"><i class="fa-solid fa-gift"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-900 text-sm">Khuyến mãi & Ưu đãi</h4>
                                <p class="text-xs text-slate-500">Nhận tin về mã giảm giá, quà tặng.</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600"></div>
                        </label>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 2. MODAL CẮT ẢNH -->
<div id="cropModal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-lg transform transition-all">
            <div class="px-6 py-4 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-900">Cắt ảnh đại diện</h3>
            </div>
            <div class="p-6">
                <div class="w-full h-80 bg-slate-100 rounded-xl overflow-hidden">
                    <img id="imageToCrop" class="max-w-full max-h-full block opacity-0 transition-opacity duration-300" src="">
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex flex-row-reverse gap-3">
                <button onclick="cropImage()" class="w-full sm:w-auto inline-flex justify-center rounded-xl bg-brand-600 px-4 py-2.5 text-sm font-bold text-white hover:bg-brand-700 shadow-lg">Xác nhận</button>
                <button onclick="rotateImage()" class="w-full sm:w-auto inline-flex justify-center rounded-xl bg-white border border-slate-300 px-4 py-2.5 text-sm font-bold text-slate-700 hover:bg-slate-50"><i class="fa-solid fa-rotate-right mr-2 mt-0.5"></i> Xoay</button>
                <button onclick="closeCropModal()" class="w-full sm:w-auto inline-flex justify-center rounded-xl bg-white border border-slate-300 px-4 py-2.5 text-sm font-bold text-slate-700 hover:bg-slate-50">Hủy</button>
            </div>
        </div>
    </div>
</div>

<!-- 3. MODAL XEM ẢNH -->
<div id="viewModal" class="fixed inset-0 z-[70] hidden" onclick="closeViewModal()">
    <div class="absolute inset-0 bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
        <button class="absolute top-4 right-4 w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all" onclick="closeViewModal()">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        <img id="fullSizeImage" src="" class="max-w-full max-h-[90vh] rounded-2xl shadow-2xl object-contain animate-[zoomIn_0.3s_ease-out]">
    </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    // 0. INIT ANIMATION
    AOS.init({ once: true, offset: 50, duration: 800 });

    // 1. TAB LOGIC
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('bg-brand-50', 'active')); // Xóa active giả

        // Reset styles cho tất cả button
        document.querySelectorAll('nav button span:first-child').forEach(span => {
            span.classList.remove('bg-brand-600', 'text-white');
            span.classList.add('bg-slate-100', 'text-slate-500');
        });
        document.querySelectorAll('nav button span:last-child').forEach(span => {
            span.classList.remove('text-brand-700');
            span.classList.add('text-slate-600');
        });

        // Set active cho button hiện tại
        const activeBtn = document.getElementById('btn-' + tabId);
        const iconSpan = activeBtn.querySelector('span:first-child');
        const textSpan = activeBtn.querySelector('span:last-child');

        activeBtn.classList.add('bg-brand-50');
        iconSpan.classList.remove('bg-slate-100', 'text-slate-500');
        iconSpan.classList.add('bg-brand-600', 'text-white');
        textSpan.classList.remove('text-slate-600');
        textSpan.classList.add('text-brand-700');

        history.replaceState(null, null, '#' + tabId);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const hash = window.location.hash.replace('#', '');
        if (['general', 'security', 'notifications'].includes(hash)) switchTab(hash);
        else switchTab('general');
    });

    // 2. PASSWORD TOGGLE
    function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        const icon = btn.querySelector('i');
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = "password";
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // 3. CROPPER LOGIC
    let cropper;
    let originalAvatarSrc = "";

    function openViewModal() {
        document.getElementById('fullSizeImage').src = document.getElementById('avatarPreview').src;
        document.getElementById('viewModal').classList.remove('hidden');
    }
    function closeViewModal() { document.getElementById('viewModal').classList.add('hidden'); }

    function initCropper(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('imageToCrop');
                img.src = e.target.result;
                img.classList.remove('opacity-0'); // Fade in image
                document.getElementById('cropModal').classList.remove('hidden');

                if (cropper) cropper.destroy();
                cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1, autoCropArea: 0.8 });
            };
            reader.readAsDataURL(input.files[0]);

            const preview = document.getElementById('avatarPreview');
            if (!originalAvatarSrc) originalAvatarSrc = preview.src;
        }
    }

    function rotateImage() { if (cropper) cropper.rotate(90); }

    function cropImage() {
        if (!cropper) return;
        cropper.getCroppedCanvas({ width: 300, height: 300 }).toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            document.getElementById('avatarPreview').src = url;

            const input = document.getElementById('avatarInput');
            const file = new File([blob], "avatar.png", { type: "image/png" });
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;

            document.getElementById('avatarActions').classList.remove('hidden');
            closeCropModal();
        });
    }

    function closeCropModal() {
        document.getElementById('cropModal').classList.add('hidden');
        if (cropper) cropper.destroy();
        if (document.getElementById('avatarActions').classList.contains('hidden')) {
            document.getElementById('avatarInput').value = '';
        }
    }

    function cancelAvatar() {
        document.getElementById('avatarPreview').src = originalAvatarSrc;
        document.getElementById('avatarInput').value = "";
        document.getElementById('avatarActions').classList.add('hidden');
    }

    // 4. VALIDATION & ADDRESS (Giữ nguyên Logic API)
    document.addEventListener("DOMContentLoaded", async () => {
        // Validation Logic
        const newPass = document.getElementById("newPass");
        const confirmPass = document.getElementById("confirmPass");
        const submitBtn = document.getElementById("btnSubmitPassword");
        const matchMsg = document.getElementById("passwordMatchMsg");

        function validateForm() {
            const val = newPass.value;
            let isValid = true;

            const checks = [
                { id: "rule-length", valid: val.length >= 8 },
                { id: "rule-case", valid: /[a-z]/.test(val) && /[A-Z]/.test(val) },
                { id: "rule-number", valid: /\d/.test(val) || /[!@#$%^&*]/.test(val) }
            ];

            checks.forEach(c => {
                const el = document.getElementById(c.id);
                if(c.valid) { el.classList.add("rule-valid"); el.classList.remove("text-slate-300"); }
                else { el.classList.remove("rule-valid"); el.classList.add("text-slate-300"); isValid = false; }
            });

            const confirmVal = confirmPass.value;
            if (confirmVal === "") {
                matchMsg.textContent = "";
                if(val !== "") isValid = false;
            } else if (val === confirmVal) {
                matchMsg.textContent = "Mật khẩu khớp";
                matchMsg.className = "text-xs mt-2 h-4 text-emerald-600 font-bold";
            } else {
                matchMsg.textContent = "Mật khẩu không khớp";
                matchMsg.className = "text-xs mt-2 h-4 text-red-500 font-bold";
                isValid = false;
            }

            submitBtn.disabled = !(isValid && val !== "");
            if(isValid && val !== "") submitBtn.classList.remove('opacity-50');
            else submitBtn.classList.add('opacity-50');
        }

        if(newPass && confirmPass) {
            newPass.addEventListener("input", validateForm);
            confirmPass.addEventListener("input", validateForm);
        }

        // Address API (Logic cũ)
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const wardSelect = document.getElementById("ward");
        const detailInput = document.getElementById("addressDetail");
        const finalAddress = document.getElementById("finalAddress");

        const fetchData = async (url) => { try { return await (await fetch(url)).json(); } catch(e) { return []; } };

        async function loadProvinces() {
            const data = await fetchData("https://provinces.open-api.vn/api/p/");
            provinceSelect.innerHTML = `<option value="">Tỉnh / Thành phố</option>`;
            data.forEach(p => provinceSelect.innerHTML += `<option value="${p.code}">${p.name}</option>`);
        }
        async function loadDistricts(code) {
            const data = await fetchData(`https://provinces.open-api.vn/api/p/${code}?depth=2`);
            districtSelect.innerHTML = `<option value="">Quận / Huyện</option>`;
            wardSelect.innerHTML = `<option value="">Phường / Xã</option>`;
            data.districts?.forEach(d => districtSelect.innerHTML += `<option value="${d.code}">${d.name}</option>`);
        }
        async function loadWards(code) {
            const data = await fetchData(`https://provinces.open-api.vn/api/d/${code}?depth=2`);
            wardSelect.innerHTML = `<option value="">Phường / Xã</option>`;
            data.wards?.forEach(w => wardSelect.innerHTML += `<option value="${w.name}">${w.name}</option>`);
        }
        function updateFinalAddress() {
            const province = provinceSelect.options[provinceSelect.selectedIndex]?.text;
            const district = districtSelect.options[districtSelect.selectedIndex]?.text;
            const ward = wardSelect.options[wardSelect.selectedIndex]?.text;
            const detail = detailInput.value.trim();
            if(!province || province.includes("Tỉnh / Thành phố")) return;
            const parts = [detail, ward, district, province].filter(p => p && !p.includes("Chọn"));
            finalAddress.value = parts.join(", ");
        }

        provinceSelect.onchange = async () => { await loadDistricts(provinceSelect.value); updateFinalAddress(); };
        districtSelect.onchange = async () => { await loadWards(districtSelect.value); updateFinalAddress(); };
        wardSelect.onchange = updateFinalAddress;
        detailInput.oninput = updateFinalAddress;

        // Auto-fill logic
        async function autoFill() {
            await loadProvinces();
            const saved = finalAddress.value; if(!saved) return;
            const parts = saved.split(",").map(s => s.trim());
            const pName = parts[parts.length - 1];

            const pOpt = [...provinceSelect.options].find(o => o.text === pName);
            if(pOpt) {
                pOpt.selected = true;
                await loadDistricts(pOpt.value);
                const dName = parts.length > 1 ? parts[parts.length - 2] : "";
                const dOpt = [...districtSelect.options].find(o => o.text === dName);
                if(dOpt) {
                    dOpt.selected = true;
                    await loadWards(dOpt.value);
                    const wName = parts.length > 2 ? parts[parts.length - 3] : "";
                    const wOpt = [...wardSelect.options].find(o => o.text === wName);
                    if(wOpt) wOpt.selected = true;
                }
            }
            if(parts.length > 3) detailInput.value = parts.slice(0, parts.length - 3).join(", ");
        }
        await autoFill();
    });
</script>

</body>
</html>